<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="James S. Clark" />

<meta name="date" content="2018-04-28" />

<title>Mast Inference and Forecasting (mastif)</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Mast Inference and Forecasting (mastif)</h1>
<h4 class="author"><em><a href="http://sites.nicholas.duke.edu/clarklab/">James S. Clark</a></em></h4>
<h4 class="date"><em>2018-04-28</em></h4>


<div id="TOC">
<ul>
<li><a href="#summary"><span style="color:darkgreen">summary</span></a></li>
<li><a href="#mastif-inputs"><span style="color:darkgreen"><code>mastif</code> inputs</span></a></li>
<li><a href="#simulated-data"><span style="color:darkgreen">simulated data</span></a><ul>
<li><a href="#mastsim"><span style="color:teal"><code>mastSim</code></span></a></li>
<li><a href="#treedata-and-xytree"><span style="color:teal"><code>treeData</code> and <code>xytree</code></span></a></li>
<li><a href="#seeddata-and-xytrap"><span style="color:teal"><code>seedData</code> and <code>xytrap</code></span></a></li>
<li><a href="#data-summary-and-maps"><span style="color:teal">data summary and maps</span></a></li>
<li><a href="#model-fitting"><span style="color:teal">model fitting</span></a></li>
<li><a href="#summary-and-plots"><span style="color:teal">summary and plots</span></a></li>
<li><a href="#slow-convergence"><span style="color:teal">slow convergence?</span></a></li>
<li><a href="#multiple-seed-types-per-species"><span style="color:teal">multiple seed types per species</span></a></li>
<li><a href="#prior-parameter-values"><span style="color:teal">prior parameter values</span></a></li>
<li><a href="#outputs"><span style="color:teal">outputs</span></a><ul>
<li><a href="#lists-in-output"><span style="color:brown">lists in <code>output</code></span></a></li>
<li><a href="#mastplot-written-to-files"><span style="color:brown"><code>mastPlot</code> written to files</span></a></li>
</ul></li>
</ul></li>
<li><a href="#my-data"><span style="color:darkgreen">my data</span></a><ul>
<li><a href="#maturationfecundity-data-if-you-have-it"><span style="color:teal">maturation/fecundity data, if you have it</span></a></li>
<li><a href="#diameter-effect"><span style="color:teal">diameter effect</span></a></li>
</ul></li>
<li><a href="#flexibility"><span style="color:darkgreen">flexibility</span></a><ul>
<li><a href="#random-individual-effects"><span style="color:teal">random individual effects</span></a></li>
<li><a href="#year-and-lag-effects"><span style="color:teal">year and lag effects</span></a></li>
<li><a href="#random-groups-for-years-and-lags"><span style="color:teal">random groups for years and lags</span></a></li>
<li><a href="#random-groups-and-individuals-with-multiple-species"><span style="color:teal">random groups and individuals with multiple species</span></a></li>
<li><a href="#fitting-arp-and-random-effects-with-multiple-species"><span style="color:teal">fitting AR(p) and random effects with multiple species</span></a></li>
<li><a href="#no-predictors"><span style="color:teal">no predictors</span></a></li>
</ul></li>
<li><a href="#when-trees-are-sampled-less-frequently-than-seeds"><span style="color:darkgreen">when trees are sampled less frequently than seeds</span></a></li>
<li><a href="#convergence"><span style="color:darkgreen">convergence</span></a></li>
<li><a href="#appendix"><span style="color:darkgreen">appendix</span></a><ul>
<li><a href="#model-overview"><span style="color:darkgreen">model overview</span></a></li>
<li><a href="#observed-quantities"><span style="color:teal">observed quantities</span></a></li>
<li><a href="#dynamic-process"><span style="color:teal">dynamic process</span></a></li>
<li><a href="#observation-model"><span style="color:teal">observation model</span></a><ul>
<li><a href="#maturation-status-observations"><span style="color:brown">maturation status observations</span></a></li>
<li><a href="#fecundity-estimates"><span style="color:brown">fecundity estimates</span></a></li>
<li><a href="#seed-counts-and-dispersal"><span style="color:brown">seed counts and dispersal</span></a></li>
</ul></li>
<li><a href="#why-is-fecundity-a-latent-variable"><span style="color:teal">why is fecundity a latent variable?</span></a></li>
<li><a href="#where-is-the-information"><span style="color:teal">where is the information?</span></a></li>
</ul></li>
<li><a href="#algorithm-notes"><span style="color:darkgreen">algorithm notes</span></a><ul>
<li><a href="#initialization"><span style="color:teal">initialization</span></a></li>
<li><a href="#latent-states"><span style="color:teal">latent states</span></a><ul>
<li><a href="#joint-fecundity-and-maturation-updates"><span style="color:brown">joint fecundity and maturation updates</span></a></li>
<li><a href="#hamiltonian-updates"><span style="color:brown">Hamiltonian updates</span></a></li>
</ul></li>
<li><a href="#coefficients"><span style="color:teal">coefficients</span></a></li>
<li><a href="#random-individual-effects-1"><span style="color:teal">random individual effects</span></a></li>
<li><a href="#random-groups-in-the-year-and-arp-models"><span style="color:teal">random groups in the year and AR(<span class="math inline">\(p\)</span>) models</span></a></li>
<li><a href="#arp-model"><span style="color:teal">AR(<span class="math inline">\(p\)</span>) model</span></a><ul>
<li><a href="#imputed-past-predicted-future"><span style="color:brown">imputed past, predicted future</span></a></li>
<li><a href="#arp-model-structure"><span style="color:brown">AR(p) model structure</span></a></li>
<li><a href="#sample-fixed-effects"><span style="color:brown">sample fixed effects</span></a></li>
<li><a href="#random-group-effects"><span style="color:brown">random group effects</span></a></li>
<li><a href="#latent-states-1"><span style="color:brown">latent states</span></a></li>
<li><a href="#year-effects"><span style="color:brown">year effects</span></a></li>
<li><a href="#other-parameters"><span style="color:brown">other parameters</span></a></li>
</ul></li>
</ul></li>
<li><a href="#references"><span style="color:darkgreen">references</span></a></li>
</ul>
</div>

<div id="citation" class="section level4">
<h4>citation:</h4>
<p><em>Clark, J.S., C. Nunes, and B. Tomasek. 2018. Pulsed-resource mast systems and the movement, demographic storage, and diet breadth of consumers, in review.</em></p>
<p><a href="http://sites.nicholas.duke.edu/clarklab/disperse/">website</a></p>
<p><br></p>
</div>
<div id="summary" class="section level2">
<h2><span style="color:darkgreen">summary</span></h2>
<p><code>mastif</code> uses seed counts from seed traps to estimate seed productivity by trees and seed dispersion. Attributes of individual trees and their local environments could explain their differences in fecundity. Inference requires information on locations of trees and seed traps, and covariates that could explain source strength.</p>
<p>Predictors of fecundity include individual traits, site characteristics, synchronicity with other trees, and lag effects. For studies that involve multiple plots and years. There may be synchronicity between individuals both within and between plots.</p>
<p>Many trees are not reproductively mature, and reproductive status is typically unknown, or partially known. For individuals of unknown maturation status, the maturation status must be estimated together with fecundity.</p>
<p>Observations incorporate two types of redistribution. The first type is a redistribution from species to seed types. Not all seed types can be definitely assigned to species. The contribution of trees of each species to multiple seed types must be estimated.</p>
<p>The second type is a redistribution from source trees to seed traps. Within a plot-year there is dependence between all seed traps induced by a redistribution kernel, which describes how the seeds produced by trees are dispersed in space. Because ‘seed shadows’ of trees overlap, seeds are assigned to trees only in a probabilistic sense. The capacity to obtain useful estimates depends on the number of trees, the number of seed traps, the dispersal distances of seeds, and the number of species contributing to a given seed type.</p>
<p>In addition to covariates and factors, the process model for fecundity can involve random tree effects, random group effects (e.g., species-location), year effects, and autoregressive lags limited only by the duration of data. Dispersal estimtes can include species and site differences.</p>
<p><code>mastif</code> simulates the posterior distributions of parameters and latent variables using Gibbs sampling, with direct sampling, Hamiltonian Markov chain updates, and Metropolis updates. <code>mastif</code> is implemented in R and C++ with <code>Rcpp</code> and <code>RcppArmadillo</code> libraries. An algorithm summary is provided at the end of this vignette (appendix).</p>
<p><br></p>
<p><br></p>
</div>
<div id="mastif-inputs" class="section level1">
<h1><span style="color:darkgreen"><code>mastif</code> inputs</span></h1>
<p>The model requires these inputs directly as arguments to the function <code>mast</code>. There are two <code>formula</code>s, two <code>character vector</code>s, and four <code>data.frame</code>s:</p>
<p><strong>Table 2</strong>. Basic inputs</p>
<table>
<colgroup>
<col width="19%"></col>
<col width="28%"></col>
<col width="52%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="right">object</th>
<th align="center"><code>mode</code></th>
<th align="left">components</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right"><code>formulaFec</code></td>
<td align="center"><code>formula</code></td>
<td align="left">fecundity model</td>
</tr>
<tr class="even">
<td align="right"><code>formulaRep</code></td>
<td align="center"><code>formula</code></td>
<td align="left">maturation model</td>
</tr>
<tr class="odd">
<td align="right"><code>specNames</code></td>
<td align="center"><code>character vector</code></td>
<td align="left">names in column <code>species</code> of <code>treeData</code> to include in model</td>
</tr>
<tr class="even">
<td align="right"><code>seedNames</code></td>
<td align="center"><code>character vector</code></td>
<td align="left">names of seed types: match column names in <code>seedData</code> to include in model</td>
</tr>
<tr class="odd">
<td align="right"><code>treeData</code></td>
<td align="center"><code>data.frame</code></td>
<td align="left">tree-year by variables, includes columns <code>tree</code>, <code>plot</code>, <code>year</code>, <code>diam</code>, <code>repr</code></td>
</tr>
<tr class="even">
<td align="right"><code>seedData</code></td>
<td align="center"><code>data.frame</code></td>
<td align="left">trap-year by seed types, includes columns <code>trap</code>, <code>plot</code>, <code>year</code>, one for each <code>specNames</code></td>
</tr>
<tr class="odd">
<td align="right"><code>xytree</code></td>
<td align="center"><code>data.frame</code></td>
<td align="left">tree by location, includes columns <code>tree</code>, <code>plot</code>, <code>x</code>, <code>y</code></td>
</tr>
<tr class="even">
<td align="right"><code>xytrap</code></td>
<td align="center"><code>data.frame</code></td>
<td align="left">trap by location, includes columns <code>trap</code>, <code>plot</code>, <code>x</code>, <code>y</code></td>
</tr>
</tbody>
</table>
<p>I introduce additional inputs in the sections that follow. These are enough to get started.</p>
<p><br></p>
</div>
<div id="simulated-data" class="section level1">
<h1><span style="color:darkgreen">simulated data</span></h1>
<p>Data simulation is recommended as the place to start. A simulator allows me to evaluate how well parameters from be identified from my data. The inputs to the simulator can specify the following:</p>
<p><strong>Table 3.</strong> Simulation inputs to <code>mastSim</code></p>
<table>
<thead>
<tr class="header">
<th align="center"><code>mastSim</code> input</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>nplot</code></td>
<td align="left">number of plots</td>
</tr>
<tr class="even">
<td align="center"><code>nyr</code></td>
<td align="left">mean no. years per plot</td>
</tr>
<tr class="odd">
<td align="center"><code>ntree</code></td>
<td align="left">mean no. trees per plot</td>
</tr>
<tr class="even">
<td align="center"><code>ntrap</code></td>
<td align="left">mean no. traps per plot</td>
</tr>
<tr class="odd">
<td align="center"><code>specNames</code></td>
<td align="left">tree species codes used in <code>treeData</code> column</td>
</tr>
<tr class="even">
<td align="center"><code>seedNames</code></td>
<td align="left">seed type codes: a column name in <code>seedData</code></td>
</tr>
</tbody>
</table>
<p>Most of these inputs are stochasiticized to vary structure of each data set. Here are inputs to the simulator for a species I’ll call <code>acerRubr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">seedNames  &lt;-<span class="st"> </span>specNames  &lt;-<span class="st"> 'acerRubr'</span>
sim &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">nyr=</span><span class="dv">10</span>, <span class="dt">ntree=</span><span class="dv">30</span>, <span class="dt">nplot=</span><span class="dv">5</span>, <span class="dt">ntrap=</span><span class="dv">40</span>, <span class="dt">meanDist =</span> <span class="dv">15</span>,
               <span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames)</code></pre></div>
<p>The <code>list sim</code> holds objects needed for simulation. Here is the simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inputs     &lt;-<span class="st"> </span><span class="kw">mastSim</span>(sim)        <span class="co"># simulate dispersal data</span>
seedData   &lt;-<span class="st"> </span>inputs$seedData     <span class="co"># year, plot, trap, seed counts</span>
trueValues &lt;-<span class="st"> </span>inputs$trueValues   <span class="co"># true states and parameter values</span>
treeData   &lt;-<span class="st"> </span>inputs$treeData     <span class="co"># year, plot, tree data</span>
xytree     &lt;-<span class="st"> </span>inputs$xytree       <span class="co"># tree locations</span>
xytrap     &lt;-<span class="st"> </span>inputs$xytrap       <span class="co"># trap locations</span>
formulaFec &lt;-<span class="st"> </span>inputs$formulaFec   <span class="co"># fecundity model</span>
formulaRep &lt;-<span class="st"> </span>inputs$formulaRep   <span class="co"># maturation model</span></code></pre></div>
<p>I first summarize these model <code>inputs</code> generated by <code>mastSim</code>.</p>
<div id="mastsim" class="section level2">
<h2><span style="color:teal"><code>mastSim</code></span></h2>
<p><code>mastSim</code> generates inputs needed for model fitting with <code>mast</code>. These objects are simulated data, including the four <code>data.frame</code>s (<code>treeData</code>, <code>seedData</code>, <code>xytree</code>, <code>xytrap</code>) and formulas (<code>formulaFec</code>, <code>formulaRep</code>). Other objects are “true” parameter values and latent states in the <code>list f$truevalues</code> used to simulate the data (<code>fec</code>,<code>repr</code>,<code>betaFec</code>, <code>betaRep</code>, <code>upar</code>, <code>R</code>). I want to see if <code>mast</code> can recover these parameter values for the type of data I simulated.</p>
<p>Here is a mapping of objects created by <code>mastSim</code> to the model summarized above:</p>
<p><strong>Table 4.</strong> <code>list</code> from <code>mastSim</code>.</p>
<table>
<thead>
<tr class="header">
<th align="center"><code>mastSim</code> object</th>
<th align="center">variable</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>trueValues$fec</code></td>
<td align="center"><span class="math inline">\(\psi_{ij,t}\)</span></td>
<td align="left">conditional fecundity</td>
</tr>
<tr class="even">
<td align="center"><code>trueValues$repr</code></td>
<td align="center"><span class="math inline">\(\rho_{ij,t}\)</span></td>
<td align="left">true maturation status</td>
</tr>
<tr class="odd">
<td align="center"><code>treeData$repr</code></td>
<td align="center"><span class="math inline">\(z_{ij,t}\)</span></td>
<td align="left">observed maturation status (with <code>NA</code>)</td>
</tr>
<tr class="even">
<td align="center"><code>trueValues$betaFec</code></td>
<td align="center"><span class="math inline">\(\beta^x\)</span></td>
<td align="left">coefficients for fecundity</td>
</tr>
<tr class="odd">
<td align="center"><code>trueValues$betaRep</code></td>
<td align="center"><span class="math inline">\(\beta^v\)</span></td>
<td align="left">coefficients for maturation</td>
</tr>
<tr class="even">
<td align="center"><code>trueValues$R</code></td>
<td align="center"><span class="math inline">\(\mathbf{r}\)</span></td>
<td align="left">species to seed types <code>matrix</code>, rows = <span class="math inline">\(\mathbf{r}_h\)</span></td>
</tr>
<tr class="odd">
<td align="center"><code>seedData$active</code></td>
<td align="center">in <span class="math inline">\(A_{sj,t}\)</span></td>
<td align="left">fraction of time trap is active</td>
</tr>
<tr class="even">
<td align="center"><code>seedData$area</code></td>
<td align="center">in <span class="math inline">\(A_{sj,t}\)</span></td>
<td align="left">trap area</td>
</tr>
</tbody>
</table>
<p>Because it is used ubiquitously, <code>mastSim</code> assumes that predictors of maturation and fecundity are limited to intercept and diameter. Thus, the <code>formulaFec</code> and <code>formulaRep</code> are identical. Here is fecundity:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">formulaFec</code></pre></div>
<p>Before fitting the model I say a bit more about input data.</p>
</div>
<div id="treedata-and-xytree" class="section level2">
<h2><span style="color:teal"><code>treeData</code> and <code>xytree</code></span></h2>
<p>The information on individual trees is held in the tree-years by variables <code>data.frame treeData</code>. Here are a few lines of <code>treeData</code> generated by <code>mastSim</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(treeData)</code></pre></div>
<p><code>treeData</code> has a row for each tree-year. Several of these columns are required:</p>
<p><strong><code>data.frame treeData</code> columns</strong></p>
<table>
<thead>
<tr class="header">
<th align="center"><code>treeData</code> column</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>tree</code></td>
<td align="left">identifier for each tree, unique within a plot</td>
</tr>
<tr class="even">
<td align="center"><code>plot</code></td>
<td align="left">plot name</td>
</tr>
<tr class="odd">
<td align="center"><code>year</code></td>
<td align="left">observation year</td>
</tr>
<tr class="even">
<td align="center"><code>species</code></td>
<td align="left">species name</td>
</tr>
<tr class="odd">
<td align="center"><code>diam, x2</code></td>
<td align="left">examples of predictor names for <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(\mathbf{V}\)</span></td>
</tr>
<tr class="even">
<td align="center"><code>repr</code></td>
<td align="left">immature (<code>0</code>), mature (<code>1</code>), or unknown (<code>NA</code>)</td>
</tr>
</tbody>
</table>
<p>There are additional columns here, but these are not required for model fitting.</p>
<p>There is a corresponding <code>data.frame xytree</code> that holds tree locations.</p>
<p><strong>Table 5.</strong> <code>data.frame xytree</code> columns</p>
<table>
<thead>
<tr class="header">
<th align="center"><code>xytree</code> column</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>tree</code></td>
<td align="left">identifier for each tree, unique within a plot</td>
</tr>
<tr class="even">
<td align="center"><code>plot</code></td>
<td align="left">plot name</td>
</tr>
<tr class="odd">
<td align="center"><code>x, y</code></td>
<td align="left">locations in the sample plot</td>
</tr>
</tbody>
</table>
<p><code>xytree</code> has fewer rows than <code>treeData</code>, because it is not repeated each year–it assumes that tree locations are fixed. They are cross-referenced by <code>plot</code> and <code>tree</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(xytree, <span class="dv">5</span>)</code></pre></div>
</div>
<div id="seeddata-and-xytrap" class="section level2">
<h2><span style="color:teal"><code>seedData</code> and <code>xytrap</code></span></h2>
<p>Seed counts are held in the <code>data.frame seedData</code> as trap-years by seed types. Here are a few lines of <code>seedData</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(seedData)</code></pre></div>
<p>Some of these columns are required.</p>
<p><strong>Table 6.</strong> <code>data.frame seedData</code> columns</p>
<table>
<thead>
<tr class="header">
<th align="center"><code>seedData</code> column</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>trap</code></td>
<td align="left">identifier for each trap, unique within a plot</td>
</tr>
<tr class="even">
<td align="center"><code>plot</code></td>
<td align="left">plot name</td>
</tr>
<tr class="odd">
<td align="center"><code>year</code></td>
<td align="left">seed year</td>
</tr>
<tr class="even">
<td align="center"><code>active</code></td>
<td align="left">fraction of collecting period that the trap was active</td>
</tr>
<tr class="odd">
<td align="center"><code>area</code></td>
<td align="left">collection area of trap (e.g., m<span class="math inline">\(^2\)</span>)</td>
</tr>
<tr class="even">
<td align="center"><code>querRubr</code>,…</td>
<td align="left"><code>seedNames</code> for columns with seed counts</td>
</tr>
</tbody>
</table>
<p>Seed trap location data are held in the <code>data.frame xytrap</code>.</p>
<p><strong>Table 7.</strong> <code>data.frame xytrap</code> columns</p>
<table>
<thead>
<tr class="header">
<th align="center"><code>xytrap</code> column</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>trap</code></td>
<td align="left">identifier for each trap, unique within a plot</td>
</tr>
<tr class="even">
<td align="center"><code>plot</code></td>
<td align="left">plot name</td>
</tr>
<tr class="odd">
<td align="center"><code>x, y</code></td>
<td align="left">map location</td>
</tr>
</tbody>
</table>
<p>There is no year, because locations are assumed to be fixed. If a seed trap location is moved during a study, simply assign it a new trap name. Then seed counts for years when it is not present are assign <code>NA</code> (missing data will be imputed).</p>
<p><br></p>
</div>
<div id="data-summary-and-maps" class="section level2">
<h2><span style="color:teal">data summary and maps</span></h2>
<p>Not all simulations from <code>mastSim</code> generate data with sufficient pattern to allow model fitting. I can look at the relationship between tree diameters and seeds on a map for plot <code>mapPlot</code> and year <code>mapYear</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dataTab &lt;-<span class="st"> </span><span class="kw">table</span>(treeData$plot,treeData$year)

w &lt;-<span class="st"> </span><span class="kw">which</span>(dataTab &gt;<span class="st"> </span><span class="dv">0</span>,<span class="dt">arr.ind=</span>T) <span class="co"># a plot-year with observations</span>
w &lt;-<span class="st"> </span>w[<span class="kw">sample</span>(<span class="kw">nrow</span>(w),<span class="dv">1</span>),]

mapYears &lt;-<span class="st"> </span><span class="kw">as.numeric</span>( <span class="kw">colnames</span>(dataTab)[w[<span class="dv">2</span>]] )
mapPlot  &lt;-<span class="st"> </span><span class="kw">rownames</span>(dataTab)[w[<span class="dv">1</span>]]

<span class="kw">mastMap</span>(inputs, <span class="dt">treeSymbol=</span>treeData$diam, <span class="dt">mapPlot =</span> mapPlot, 
        <span class="dt">mapYears =</span> mapYears, <span class="dt">SCALEBAR =</span> T)</code></pre></div>
<p>Depending on the numbers of maps I adust <code>scaleTree</code> and <code>scaleTrap</code> to see how seed accumulation compares with fecundities of trees. In the above map, trees are shown as green circles and traps as gray squares. The size of the circle comes from the input variable <code>treeSymbol</code>, which is set to tree diameter. I could instead set it to the ‘true’ number of seeds produced by each tree, an output from <code>mastSim</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trueValues &lt;-<span class="st"> </span>inputs$trueValues
<span class="kw">mastMap</span>(inputs, <span class="dt">treeSymbol=</span>trueValues$fec, <span class="dt">mapPlot =</span> mapPlot, 
        <span class="dt">mapYears =</span> mapYears, <span class="dt">scaleTree=</span><span class="dv">1</span>, <span class="dt">scaleTrap =</span> <span class="dv">1</span>, <span class="dt">SCALEBAR =</span> T)</code></pre></div>
<p>To fit the data, there must be sufficient seed traps, and sources must not be so dense such that overlapping seed shadows make the individual contributions undetectable (Appendix).</p>
<p>Here is the frequency distribution of seeds (observed) and of fecundities (unknown) from the simulated data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>( <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>),<span class="dt">bty=</span><span class="st">'n'</span>, <span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">1</span>) )
seedData &lt;-<span class="st"> </span>inputs$seedData
seedNames &lt;-<span class="st"> </span>inputs$seedNames

<span class="kw">hist</span>( <span class="kw">as.matrix</span>(seedData[,seedNames]) ,<span class="dt">nclass=</span><span class="dv">100</span>, 
      <span class="dt">xlab =</span> <span class="st">'seed count'</span>, <span class="dt">ylab=</span><span class="st">'per trap'</span>, <span class="dt">main=</span><span class="st">''</span> )
<span class="kw">hist</span>( trueValues$fec,<span class="dt">nclass=</span><span class="dv">100</span>, <span class="dt">xlab =</span> <span class="st">'seeds produced'</span>, <span class="dt">ylab =</span> <span class="st">'per tree'</span>,
      <span class="dt">main =</span> <span class="st">''</span>)</code></pre></div>
<p>In data of this type, most seed counts and most tree fecundities are zero.</p>
<p><br></p>
</div>
<div id="model-fitting" class="section level2">
<h2><span style="color:teal">model fitting</span></h2>
<p>Model fitting requires specification of the number of MCMC iterations <code>ng</code> and the <code>burnin</code>. Here is an analysis using the simulated <code>inputs</code> from <code>mastSim</code> with a small number of iterations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output   &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> inputs, <span class="dt">ng =</span> <span class="dv">1500</span>, <span class="dt">burnin =</span> <span class="dv">500</span> )</code></pre></div>
</div>
<div id="summary-and-plots" class="section level2">
<h2><span style="color:teal">summary and plots</span></h2>
<p>Here are the estimates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>( output )</code></pre></div>
<p>Sample size, parameter estimates, goodness of fit are all summarized by <code>summary</code>.</p>
<p>Here are plots of <code>output</code>, with the <code>list plotPars</code> passing the <code>trueValues</code> for these simulated data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotPars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">trueValues =</span> trueValues)
<span class="kw">mastPlot</span>(output, plotPars)</code></pre></div>
<p><code>mastPlot</code> generates the following plots:</p>
<ul>
<li><p><code>seeds vs BA by yr</code>: basal area and seeds per basal area, by plot.</p></li>
<li><p><code>maturation</code>: chains for maturation parameters in <span class="math inline">\(\beta^v\)</span>.</p></li>
<li><p><code>fecundity</code>: chains for fecundity parameters in <span class="math inline">\(\beta^x\)</span>.</p></li>
<li><p><code>dispersal parameter</code>: chains for dispersal parameter <span class="math inline">\(u\)</span>.</p></li>
<li><p><code>variance sigma</code>: chains for error variance <span class="math inline">\(\sigma^2\)</span> and RMSPE.</p></li>
<li><p><code>fecundity, maturation</code>: posterior 68% (boxes) and 95% (whiskers) for <span class="math inline">\(\beta^x\)</span> and <span class="math inline">\(\beta^v\)</span>.</p></li>
<li><p><code>maturation by diameter</code>: estimates with <span class="math inline">\(95%\)</span> predictive mean.</p></li>
<li><p><code>seed shadow</code>: with 90% predictive interval</p></li>
<li><p><code>prediction</code>: seed data predicted from estimates of latent maturation and fecundity (a) and from parameter estimates. If <code>trueValues</code> are supplied from <code>mastSim</code>, then panel (c) includes true versus predicted values. There is an important distinction between (a) and (b)–good predictions in (a) indicate that combinations of seed sources can be found to predict the seed data, without necessarily meaning that the process model can predict maturation and fecundity. Good predictions in (b) face the steeper challenge that the process model must predict both maturation and fecundity, which, in turn, predict seed rain.</p></li>
<li><p><code>parameter recovery</code>: if <code>trueValues</code> are supplied from <code>mastSim</code>, then this plot is provided comparing true and estimated values for <span class="math inline">\(\beta^v\)</span> and <span class="math inline">\(\beta^x\)</span>.</p></li>
<li><p><code>predicted fecundity, seed data</code>: maps show predicted fecundity of trees (sizes of green circles) with seed data (gray squares). If <code>predList</code> is supplied to <code>mastif</code>, then the predicted seed surface is shown as shaded contours.</p></li>
<li><p><code>production by plot and year</code>: predictions showing variation across plot area</p></li>
<li><p><code>partial ACF</code>: autocorrelation function for fecundity (a) and in seed counts (b).</p></li>
<li><p><code>tree correlation in time</code>: pairwise correlations between trees on the same plot.</p></li>
<li><p><code>Resource scores</code>: to a consumer, combining benefit of large mean, cost of large variance (Clark et al. 2018). A second plot shows only plot names.</p></li>
</ul>
<p>The plots displayed by <code>mastPlot</code> include the MCMC chains that are not yet converged. I can restart where I left off by using <code>output</code> as the <code>inputs</code> to <code>mast</code>. In addition, I predict the seed surface from the fitted model for a plot and year, as specified in <code>predList</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">mapMeters =</span> <span class="dv">3</span>, <span class="dt">plots =</span> mapPlot, <span class="dt">years =</span> mapYears ) 
output   &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> output, <span class="dt">ng =</span> <span class="dv">2000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>, 
                  <span class="dt">predList =</span> predList)</code></pre></div>
<p>Landscape seed intensity depends on dispersal. To look closer at the predicted plot-year I generate a new map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mastMap</span>(output, <span class="dt">mapPlot =</span> predList$plots, <span class="dt">mapYears =</span> predList$years, 
        <span class="dt">scaleTree =</span> <span class="dv">2</span>, <span class="dt">scaleTrap =</span> .<span class="dv">5</span>, <span class="dt">PREDICT =</span> T, <span class="dt">scaleValue =</span> <span class="dv">20</span>)</code></pre></div>
<p>The maps show seed counts (squares) and fecundity predictions (circles). For predicted plot years there is also shown a seed prediction surface. The surface is seeds per m<span class="math inline">\(^2\)</span>.</p>
<p>Depending on the simulation, convergence may require more iterations. The partial autocorrelation for years should be weak, because none are simulated in <code>mastSim</code>. However, actual data will contain autocorrelation. The fecundity-time correlations show modal values near zero, because simulated data do not include individual covariance. Positive spatial covariance is imposed by dispersal.</p>
<p><br></p>
</div>
<div id="slow-convergence" class="section level2">
<h2><span style="color:teal">slow convergence?</span></h2>
<p>Seed shadow models confront convoluted likelihood surfaces, in the sense that we expect many local optima. These surfaces are hard to traverse, because maturation status is a binary state that must be proposed and accepted together with latent fecundity. Posterior simulation can get bogged down when fecundity estimates converge for a combination of mature and immature trees that is locally but not globally optimal. Especially when there are more trees of a species than there are seed traps, we expect many iterations before the algorithm can ‘find’ the specific combination of trees that together best describe the specific combination of seed counts in many seed traps. Compounding the challenge is the fact that, because both maturation and fecundity are latent variables for each individual, the redistribution kernel must be constructed anew at each MCMC step. Yet, analysis of simulated data shows that convergence to the correct posterior distribution is common. It just may take trial and error with prior parameter values (see below) and long chains.</p>
<p>Examples in this vignette assign enough interations to show this progress toward convergence, sufficiently few to avoid long waiting times. To evaluate convergence, consider the plots for chains of <code>sigma</code> (the residual variance <span class="math inline">\(\sigma\)</span> on log fecundity) and <code>rspse</code> (the seed count residual). Finally, the plot of seed observed vs predicted gives a sense of progress.</p>
<p>As demonstrated above, restart <code>mastif</code> with the fitted object.</p>
<p><br></p>
</div>
<div id="multiple-seed-types-per-species" class="section level2">
<h2><span style="color:teal">multiple seed types per species</span></h2>
<p>Often a seed type could have come from trees of more than one species. Seeds only be identified to genus level include in <code>seedNames</code> the <code>character</code> string <code>UNKN</code>. In this simulation the three species <code>pinuTaeda</code>, <code>pinuEchi</code>, and <code>pinuVirg</code> contribute most seeds to the type <code>pinuUNKN</code>. Here are some inputs for the simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">specNames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'pinuTaeda'</span>,<span class="st">'pinuEchi'</span>,<span class="st">'pinuVirg'</span>)
seedNames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'pinuTaeda'</span>,<span class="st">'pinuEchi'</span>,<span class="st">'pinuVirg'</span>,<span class="st">'pinuUNKN'</span>)
sim    &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">nyr=</span><span class="dv">5</span>, <span class="dt">ntree=</span><span class="dv">25</span>, <span class="dt">nplot=</span><span class="dv">8</span>, <span class="dt">ntrap=</span><span class="dv">50</span>, <span class="dt">specNames =</span> specNames,
                  <span class="dt">seedNames =</span> seedNames)</code></pre></div>
<p>There is a <code>specNames</code>-by-<code>seedNames</code> matrix that is estimated as part of the posterior distribution. For this example <code>seedNames</code> containing the string <code>UNKN</code> refers to a seed type that cannot be differentiated beyond the level of the genus <code>pinu</code>.</p>
<p>Here is the simulation with output objects with 2/3 of all seeds identified only to genus level:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inputs &lt;-<span class="st"> </span><span class="kw">mastSim</span>(sim)        <span class="co"># simulate dispersal data</span>
R      &lt;-<span class="st"> </span>inputs$trueValues$R <span class="co"># species to seedNames probability matrix</span>
R</code></pre></div>
<p>The matrix <code>R</code> stacks the length-<span class="math inline">\(R\)</span> vectors <span class="math inline">\(\mathbf{r}'_s\)</span> discussed in model description as a species by seed type matrix. There is a matrix for each plot, here stacked as a single matrix. This is the matrix of values used in simulation. <code>mastif</code> will estimate this matrix as part of the posterior distribution.</p>
<p>Here is a model fit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> inputs, <span class="dt">ng =</span> <span class="dv">2000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>)</code></pre></div>
<p>The model summary now includes estimates for the unknown <code>R</code> as the “species to seed type matrix”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>( output )</code></pre></div>
<p>Output plots will include chains for estimates in <code>R</code>. There will also be estimates for each species included in <code>specNames</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotPars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">trueValues =</span> inputs$trueValues) 
<span class="kw">mastPlot</span>(output, plotPars)</code></pre></div>
<p>Here is a restart, now with <code>plots</code> and <code>years</code> specified for prediction in <code>predList</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tab   &lt;-<span class="st"> </span><span class="kw">with</span>( inputs$seedData, <span class="kw">table</span>(plot, year) )
years &lt;-<span class="st"> </span><span class="kw">as.numeric</span>( <span class="kw">colnames</span>(tab)[tab[<span class="dv">1</span>,] &gt;<span class="st"> </span><span class="dv">0</span>] ) <span class="co"># years for 1st plot</span>
predList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">plots =</span> <span class="st">'p1'</span>, <span class="dt">years =</span> years ) 
output &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> output, <span class="dt">ng =</span> <span class="dv">5000</span>, <span class="dt">burnin =</span> <span class="dv">2000</span>, 
                  <span class="dt">predList =</span> predList)
<span class="kw">mastPlot</span>(output, plotPars)</code></pre></div>
</div>
<div id="prior-parameter-values" class="section level2">
<h2><span style="color:teal">prior parameter values</span></h2>
<p>In previous examples, the prior distribution was non-informative, because I did not specify parameter values. I can specify prior values as inputs through the <code>list inputs</code>:</p>
<p><strong>Table 8.</strong> Components of <code>inputs</code>.</p>
<table>
<thead>
<tr class="header">
<th align="right">object</th>
<th align="left">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right"><code>priorR = uniform</code></td>
<td align="left"><code>seedNames</code> by <code>specNames</code> prior <code>matrix</code>, columns sum to 1</td>
</tr>
<tr class="even">
<td align="right"><code>priorRwt = priorR</code></td>
<td align="left"><code>seedNames</code> by <code>specNames</code> prior weight <code>matrix</code></td>
</tr>
<tr class="odd">
<td align="right"><code>priorDist = 10</code></td>
<td align="left">prior mean dispersal distance (<span class="math inline">\(m\)</span>)</td>
</tr>
<tr class="even">
<td align="right"><code>priorVDist = 20</code></td>
<td align="left">prior variance dispersal parameter</td>
</tr>
<tr class="odd">
<td align="right"><code>minDist = 2</code></td>
<td align="left">minimum mean dispersal distance (<span class="math inline">\(m\)</span>)</td>
</tr>
<tr class="even">
<td align="right"><code>maxDist = 60</code></td>
<td align="left">maximum mean dispersal distance (<span class="math inline">\(m\)</span>)</td>
</tr>
<tr class="odd">
<td align="right"><code>maxF = 1e+8</code></td>
<td align="left">maximum fecundity (seeds per tree-year)</td>
</tr>
<tr class="even">
<td align="right"><code>minDiam = 2</code></td>
<td align="left">minimum <code>diam</code> below which a tree can mature (<span class="math inline">\(cm\)</span>)</td>
</tr>
<tr class="odd">
<td align="right"><code>maxDiam = 80</code></td>
<td align="left">maximum <code>diam</code> above which a tree can be immature (<span class="math inline">\(cm\)</span>)</td>
</tr>
<tr class="even">
<td align="right"><code>betaPrior</code></td>
<td align="left"><code>list</code> of <code>character</code> vectors naming <code>pos</code> and <code>neg</code> predictors</td>
</tr>
<tr class="odd">
<td align="right"><code>sigmaMu &lt;- .5</code></td>
<td align="left">prior mean residual variance <span class="math inline">\(\sigma^2\)</span></td>
</tr>
<tr class="even">
<td align="right"><code>sigmaWt = nrow(treeData)</code></td>
<td align="left">weight on prior mean (no. of observations)</td>
</tr>
</tbody>
</table>
<p>Note that <code>betaPrior</code> specifies predictor effects by sign. An example is provided below.</p>
<p>It is important to modify these values, depending on species. Here are a few suggestions:</p>
<ul>
<li><p>In general, large-seeded species dispersed by vertebrates generate noisy seed-trap data, despite the fact that the bulk of the counts still occur close to the parent, and the mean dispersal distance is relatively low. Large-seeded species produce few fruits/seeds. Long-distance dispersal cannot be estimated from inventory plots, regardless of size, because the fit is dominated by locally-derived seed. Consider values for maximum fecundity as low as <code>maxF = 10000</code>, minimum dispersal <code>minDist = 2</code>, and maximum dispersal <code>maxDist = 12</code>. Recall that the latter values refer to the dispersal kernel parameter value, not the maximum distance a seed can travel, which is un-constrained.</p></li>
<li><p>The columns of <code>priorR</code> can include zeros, for species-seedtype combinations that never occur. All other values will combine with data, depending on the weight of the prior. Large values in <code>priorRwt</code> place large weight on the prior. For a concrete example, if most trees on a plot are <em>Acer rubrum</em>, but most seeds are indentified as <code>seedNames acerUNKN</code>, then a column in <code>R</code> might assign a value close to 1 in the row for <code>acerUNKN</code> and a non-zero column of <code>acerRubr</code>.</p></li>
</ul>
<p>Examples are provided below.</p>
<p><br></p>
</div>
<div id="outputs" class="section level2">
<h2><span style="color:teal">outputs</span></h2>
<p>Outputs consist of MCMC chains, tables, and graphs. The main objects returned by <code>mastif</code> include several lists:</p>
<div id="lists-in-output" class="section level3">
<h3><span style="color:brown">lists in <code>output</code></span></h3>
<p>Each of the lists are summarized below. <code>parameters</code> are estimated as part of model fitting. <code>predictions</code> are generated by the fitted model, as predictive distributions. Note that the latent states <span class="math inline">\(\psi_{ij,t}\)</span> and <span class="math inline">\(\rho_{ij,t}\)</span> can be both.</p>
<p><strong>Table 9.</strong> The <code>list</code> created by function <code>mast</code>.</p>
<table>
<colgroup>
<col width="20%"></col>
<col width="13%"></col>
<col width="65%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="right"><code>list</code> in <code>output</code></th>
<th align="center">summary</th>
<th align="left">contents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right"><code>inputs</code></td>
<td align="center">from <code>inputs</code>, with additions</td>
<td align="left"><code>distall</code> (trap by tree distance), <code>sizeDist</code> (group by distance …), <code>spaceDist</code> …, <code>spaceMu</code> (plot seed intensity by distance (1/m/m)), <code>spaceVr</code> …</td>
</tr>
<tr class="even">
<td align="right"><code>chains</code></td>
<td align="center">MCMC chains</td>
<td align="left"><code>agibbs</code> (random effects covariance matrix <span class="math inline">\(\mathbf{A}\)</span>), <code>bfec</code> (<span class="math inline">\(\boldsymbol{\beta}^x\)</span>), <code>brep</code> (<span class="math inline">\(\boldsymbol{\beta}^v\)</span>), <code>bygibbs</code> (<span class="math inline">\(\alpha_l\)</span> or <span class="math inline">\(\gamma_t\)</span> if <code>yearEffect</code> included) <code>rgibbs</code> (<span class="math inline">\(\mathbf{R}\)</span> if multiple seed types), <code>ugibbs</code> (<span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(u\)</span>, RMSPE)</td>
</tr>
<tr class="odd">
<td align="right"><code>fit</code></td>
<td align="center">diagnostics</td>
<td align="left">DIC, RMSPE, predictScore</td>
</tr>
<tr class="even">
<td align="right"><code>parameters</code></td>
<td align="center">posterior summaries</td>
<td align="left"><code>alphaMu</code> and <code>alphaSe</code> (mean and se for <span class="math inline">\(\mathbf{A}\)</span>, if included), <code>aMu</code> and <code>aSe</code> (<span class="math inline">\(\mathbf{\beta^w}_{ij}\)</span>), <code>betaFec</code> (<span class="math inline">\(\boldsymbol{\beta}^x\)</span>), <code>betaRep</code> (<span class="math inline">\(\boldsymbol{\beta}^v\)</span>), <code>betaYrMu</code> and <code>betaYrSe</code> (mean and se for year or lag coefficients), <code>mMu</code> and <code>mSe</code> (mean and se for <span class="math inline">\(\mathbf{R}\)</span>), <code>sigma</code> (<span class="math inline">\(\sigma^2\)</span>), <code>acfMat</code> (group by lag empirical correlation or ACF), <code>pacfMat</code> (group by lag partial correlation or PACF), <code>pacfSe</code> (se for <code>pacfMat</code>), <code>pacsMat</code> (group by lag PACF for seed data), <code>sigmaList</code> (fecundity year correlation matrix across trees), <code>omegaList</code> (fecundity tree correlation matrix across years)</td>
</tr>
<tr class="odd">
<td align="right"><code>prediction</code></td>
<td align="center">predictive distributions</td>
<td align="left"><code>fecPred</code> (maturation <span class="math inline">\(\rho_{ij,t}\)</span> and fecundity <span class="math inline">\(\psi_{ij,t}\)</span> estimates and predictions) and <code>seedPred</code> (seed counts per trap and predictions per m<span class="math inline">\(^2\)</span>)</td>
</tr>
</tbody>
</table>
</div>
<div id="mastplot-written-to-files" class="section level3">
<h3><span style="color:brown"><code>mastPlot</code> written to files</span></h3>
<p>The <code>function mastPlot</code> generates summary plots of output. The user has access to all objects used to generate these plots, as discussed in the previous section. Plots in <code>mastPlot</code> can be rendered to the screen unless <code>SAVEPLOTS=T</code> is included in the <code>list plotPars</code> passed to <code>mastPlot</code>.</p>
<p><br></p>
</div>
</div>
</div>
<div id="my-data" class="section level1">
<h1><span style="color:darkgreen">my data</span></h1>
<p>For illustration I use sample data analyzed by Clark et al. (2013), with data collection that has continued through 2017. It consists of multiple years and sites.</p>
<p>Here I load data for species with a single recognized seed type, <em>Liriodendron tulipifera</em>. Here is a map, with seed traps scaled by seed counts, and trees scaled by diameter,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(repmis)
d &lt;-<span class="st"> &quot;https://github.com/jimclarkatduke/mast/blob/master/mast_liri.Rdata?raw=True&quot;</span>
<span class="kw">source_data</span>(d)
mapList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">treeData =</span> treeData, <span class="dt">seedData =</span> seedData, 
                 <span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames, 
                 <span class="dt">xytree =</span> xytree, <span class="dt">xytrap =</span> xytrap)
<span class="kw">mastMap</span>(mapList, <span class="dt">mapPlot =</span> <span class="st">'DF_HW'</span>, <span class="dt">mapYear =</span> <span class="dv">2011</span>:<span class="dv">2014</span>, 
        <span class="dt">treeSymbol =</span> treeData$diam, <span class="dt">scaleTree =</span> <span class="dv">1</span>, <span class="dt">scaleTrap=</span>.<span class="dv">7</span>,
        <span class="dt">SCALEBAR=</span>T, <span class="dt">scaleValue=</span><span class="dv">50</span>)</code></pre></div>
<p>Here are a few lines of <code>treeData</code>, which has been trimmed down to this single species,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(treeData, <span class="dv">3</span>)</code></pre></div>
<p>Here are a few lines of <code>seedData</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(seedData, <span class="dv">3</span>)</code></pre></div>
<div id="maturationfecundity-data-if-you-have-it" class="section level2">
<h2><span style="color:teal">maturation/fecundity data, if you have it</span></h2>
<p>Most individuals produce no seed, due to resource limitation, especially light, in crowded stands. As trees increase in size and resource access they mature, and become capable of seed production. Maturation is hard to observe, so it must be modelled. In our data sets, maturation status is observed, but most values are NA; it is only assigned if certain. A value of 1 means that reproduction is observed. A value of zero means that the entire crown is visible during the fruiting season, and it is clear that no reproduction is present. Needless to say, most observations are NA. The observations are entered in the column <code>repr</code> in the <code>data.frame treeData</code>. Below I show an example where <code>minDiam</code> is set as a prior that trees of smaller diameters are mature.</p>
<p><code>mastif</code> further admits estimates of minimum and maximum seed production for a given tree year. These counts enter as columns <code>fecMin</code> and <code>fecMax</code> in <code>treeData</code>. Again, most values can be <code>NA</code>. Admissible values are <code>0 &lt;= fecmin &lt; fecMax</code>.</p>
</div>
<div id="diameter-effect" class="section level2">
<h2><span style="color:teal">diameter effect</span></h2>
<p>Here I fit the model using the variables <code>canopy</code> and <code>I(log(diam))</code> as predictors. These appear as the columns <code>canopy</code> and <code>diam</code> in <code>treeData</code>. The <code>diam</code> column will be fitted as log diameter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">formulaFec &lt;-<span class="st"> </span><span class="kw">as.formula</span>( ~<span class="st"> </span>canopy +<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) )   <span class="co"># fecundity model</span>
formulaRep &lt;-<span class="st"> </span><span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) )            <span class="co"># maturation model</span>

inputs   &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames, 
                 <span class="dt">treeData =</span> treeData, <span class="dt">seedData =</span> seedData, <span class="dt">xytree =</span> xytree, 
                 <span class="dt">xytrap =</span> xytrap, <span class="dt">priorDist =</span> <span class="dv">25</span>, <span class="dt">priorVDist =</span> <span class="dv">5</span>, <span class="dt">minDist =</span> <span class="dv">8</span>,
                 <span class="dt">maxDist =</span> <span class="dv">40</span>, <span class="dt">sigmaMu =</span> <span class="dv">1</span>, <span class="dt">minDiam =</span> <span class="dv">10</span>, <span class="dt">maxDiam =</span> <span class="dv">60</span>)
output &lt;-<span class="st"> </span><span class="kw">mastif</span>( formulaFec, formulaRep, <span class="dt">inputs =</span> inputs,  <span class="dt">ng =</span> <span class="dv">1500</span>, 
                  <span class="dt">burnin =</span> <span class="dv">500</span> )</code></pre></div>
<p>Following this short sequence, I fit a longer one and predict one of the plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">mapMeters =</span> <span class="dv">10</span>, <span class="dt">plots =</span> <span class="st">'DF_HW'</span>, <span class="dt">years =</span> <span class="dv">2010</span>:<span class="dv">2015</span> ) 
output &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> output, <span class="dt">ng =</span> <span class="dv">4000</span>, <span class="dt">burnin =</span> <span class="dv">1500</span>, <span class="dt">predList =</span> predList )</code></pre></div>
<p>Here are some plots followed by comments on display panels. Notice that when it progresses to the maps for plot DF_HW, they will include the predicted seed shadows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mastPlot</span>(output)</code></pre></div>
<p>From <code>fecundity</code> chains, still more iterations are needed for convergence.</p>
<p>Both <code>canopy</code> and <code>log(diam)</code> contribute to fecundity. <code>log(diam)</code> contributes to maturation.</p>
<p>From <code>seed shadow</code>, seed rain beneath a 20-cm diameter tree averages near 0.2 seeds per m<span class="math inline">\(^2\)</span>.</p>
<p>Although a combination of maturation/fecundity can be found to predict the seed data in <code>prediction</code> (part a), the process model does not well predict the maturation/fecundity combination (part b). In other words, the maturation/fecundity/dispersal aspect of the model is effective, whereas the design does not yet include variables that help explain maturation/fecundity.</p>
<p>From the many maps in <code>predicted fecundity, seed data</code>, note that the <code>DF_HW</code> site includes prediction surfaces, as specfied in <code>predList</code>.</p>
<p>Here is the summary:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>( output )</code></pre></div>
<p>At this point in the the Gibbs sampler, the DIC and root mean square prediction error is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output$fit</code></pre></div>
</div>
</div>
<div id="flexibility" class="section level1">
<h1><span style="color:darkgreen">flexibility</span></h1>
<p>Seed production is volatile, with order of magnitude variation from year-to-year. There is synchronicity among individuals of the same species, the “masting” phenomenon. There are large difference between individuals, that are not explained by environmental variables. In this section I discuss extensions to random effects, year effects, lag effects, and fitting multiple species having seed types that are not always identifiable to species.</p>
<div id="random-individual-effects" class="section level2">
<h2><span style="color:teal">random individual effects</span></h2>
<p>Random individual effects include random intercepts and slopes for the fecundities of each individual tree that is imputed to be in the mature state for at least 3 years. [There are no random effects on maturation, because they would be hard to identify from seed trap data for this binary response.]</p>
<p>I include in the <code>inputs list</code> the <code>list randomEffect</code>, which includes the column name for the random group. Typically this would be a unique identifier for a tree within a plot, e.g., <code>randomEffect$randGroups = 'tree'</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">randomEffect &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">randGroups =</span> <span class="st">'tree'</span>, 
                     <span class="dt">formulaRan =</span> <span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) ) )</code></pre></div>
<p>However, <code>randGroups</code> could be the plot name. This column is interpreted as a <code>factor</code>, each level being a group. Random effects will not be fitted on individuals that are in the mature state less than 3 years.</p>
<p>The <code>formulaRan</code> is the random effects model. It includes a subset of variables specified in fecundity model <code>formulaFec</code>. [Because random effects are centered on zero, terms in <code>formulaRan</code> must already be included in the fecundity design <code>formulaFec</code> (see appendix).] Here is a brief description of what’s happening:</p>
<p>There is a design vector <span class="math inline">\(\mathbf{w}_{ij,t}\)</span> that can include all or some of the columns in <span class="math inline">\(\mathbf{x}_{ij,t}\)</span>. There is an individual-effects coefficient matrix <span class="math inline">\(\boldsymbol{\beta}^w_{ij}\)</span>, which enters the mean structure this way:</p>
<p><span class="math display">\[\log \psi_{ij,t} \sim N \left( \mathbf{x}'_{ij,t} \boldsymbol{\beta}^x + \mathbf{w}'_{ij,t} \boldsymbol{\beta}^w_{ij}, \sigma^2 \right)\]</span> Here I add random effects to the previous model fit. I cannot use <code>inputs = output</code>, because I am changing the model. However, I can avoid reinitializing states if I add the ending states from the previous fit as new columns to <code>treeData</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">treeData$lastFec &lt;-<span class="st"> </span>output$inputs$treeData$lastFec
treeData$lastRep &lt;-<span class="st"> </span>output$inputs$treeData$lastRep
inputs$treeData  &lt;-<span class="st"> </span>treeData</code></pre></div>
<p>Here is a fit with random effects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">randomEffect &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">randGroups =</span> <span class="st">'tree'</span>, 
                     <span class="dt">formulaRan =</span> <span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) ) )
output &lt;-<span class="st"> </span><span class="kw">mastif</span>( formulaFec, formulaRep, <span class="dt">inputs =</span> inputs, 
                  <span class="dt">ng =</span> <span class="dv">2000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>,
                  <span class="dt">randomEffect =</span> randomEffect )</code></pre></div>
<p>Here is a restart:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output &lt;-<span class="st"> </span><span class="kw">mastif</span>( <span class="dt">inputs =</span> output, <span class="dt">ng =</span> <span class="dv">4000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>,
                  <span class="dt">randomEffect =</span> randomEffect)
<span class="kw">mastPlot</span>(output)</code></pre></div>
<p>There are several things to note:</p>
<ul>
<li><p>there is a new panel for <code>random effects</code>, showing the individual combinations of intercepts and <code>log(diam)</code> slopes.</p></li>
<li><p>the <code>prediction</code> panel (b) shows only slight improvement, indicating that even with random effects, the model struggles to predict maturation/fecundity.</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output$fit</code></pre></div>
</div>
<div id="year-and-lag-effects" class="section level2">
<h2><span style="color:teal">year and lag effects</span></h2>
<p>The model admits year effects and lag effects, the latter as an AR(p) model. Year effects assign a coefficient to each year <span class="math inline">\(t = [1, \dots, T_j]\)</span>. Lag effects assign a coefficient to each of <span class="math inline">\(p \in \{1, \dots, P\}\)</span> plags, where the maximum lag <span class="math inline">\(P\)</span> should be substantially less than the number of years in the study. Year effects can be organized in random groups. Specification of random groups is done in the same way for year effects and for lag effects.</p>
</div>
<div id="random-groups-for-years-and-lags" class="section level2">
<h2><span style="color:teal">random groups for years and lags</span></h2>
<p>I define random groups for year and lag effects by species groups, by plot groups, or both. When there are multiple species that contribute to the modeled seed types, I expect the year effects to depend on which species is actually producing the seed. <code>specGroups</code> each have their own year or lag effects. When there are multiple plots sufficiently distant from one another, I might allow for the fact that year effects or lag effects differ by group; <code>plotGroups</code> allow that they need not mast in the same years. In the example below, I’ll use the term <em>region</em> for plots in the same plotGroup.</p>
<p>Here is a breakdown for this data set by regions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">with</span>(treeData, <span class="kw">colSums</span>( <span class="kw">table</span>(treeID, region)) )</code></pre></div>
<p>With only 10 trees in <code>region GSNP</code>, I choose not to fit a random effect for this group. Recall that only a fraction of all trees will be mature. So I reduce <code>region</code> to two groups, <code>mtn</code> and <code>piedmont</code>, and place them in a new column <code>province</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">province &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">'mtn'</span>,<span class="kw">nrow</span>(treeData))
province[treeData$region ==<span class="st"> 'DF'</span>] &lt;-<span class="st"> 'piedmont'</span>
treeData$province &lt;-<span class="st"> </span><span class="kw">as.factor</span>(province)</code></pre></div>
<p>Here are year effects structured by random groups of plots, given by the column <code>province</code> in <code>treeData</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">yearEffect &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">plotGroups =</span> <span class="st">'province'</span>)</code></pre></div>
<p>This option will fit a year effect for both provinces and years having sufficient individuals estimated to be in the mature state. Here is the model with random year effects,</p>
<p><span class="math display">\[\log \psi_{ij,t} \sim N \left( \mathbf{x}'_{ij,t} \mathbf{\beta}^x + \gamma_t + \gamma_{g[i],t}, \sigma^2 \right)\]</span> where the year effect <span class="math inline">\(\gamma_{g[i],t}\)</span> is shared by trees in all plots defined by <code>yearEffect$province</code>, <span class="math inline">\(ij \in g\)</span>. Year effects are sampled directly from conditional posteriors (see Appendix).</p>
<p>To begin this new run, I choose to initialize fecundity and maturation where it left off from fitting the previous model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">treeData$lastFec &lt;-<span class="st"> </span>output$inputs$treeData$lastFec
treeData$lastRep &lt;-<span class="st"> </span>output$inputs$treeData$lastRep</code></pre></div>
<p>Now the new fit will not reinitialize:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inputs$treeData  &lt;-<span class="st"> </span>treeData
output &lt;-<span class="st"> </span><span class="kw">mastif</span>(formulaFec, formulaRep,  <span class="dt">inputs =</span> inputs, <span class="dt">ng =</span> <span class="dv">1500</span>, <span class="dt">burnin =</span> <span class="dv">500</span>, 
               <span class="dt">randomEffect =</span> randomEffect, <span class="dt">yearEffect =</span> yearEffect)</code></pre></div>
<p>Here is a restart, with predictions for one of the plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">mapMeters =</span> <span class="dv">10</span>, <span class="dt">plots =</span> <span class="st">'DF_HW'</span>, <span class="dt">years =</span> <span class="dv">1998</span>:<span class="dv">2014</span> ) 
output &lt;-<span class="st"> </span><span class="kw">mastif</span>(<span class="dt">inputs =</span> output, <span class="dt">predList =</span> predList, 
               <span class="dt">randomEffect =</span> randomEffect, <span class="dt">yearEffect =</span> yearEffect, 
               <span class="dt">ng =</span> <span class="dv">3000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>)
<span class="kw">mastPlot</span>(output)</code></pre></div>
<p>Note that still more iterations are needed for convergence. Here are some comments on <code>mastPlot</code>:</p>
<ul>
<li><p>In the <code>dispersal parameter u</code> panel there are now year effects plotted for the two random groups <code>mtn</code> and <code>piedmont</code>.</p></li>
<li><p>The subsequent panel <code>dispersal mean and variance</code> shows the mean and variance of random effects</p></li>
<li><p>There is a <code>dispersal by group</code> panel showing posterior estimate for the two random groups, with scales for the parameter <span class="math inline">\(u\)</span> on the left (m<span class="math inline">\(^2\)</span>) and mean parameter <span class="math inline">\(d\)</span> on the right (m).</p></li>
<li><p>There has been some improvement in the <code>prediction</code>, panel (b).</p></li>
<li><p>The <code>predicted fecundity, seed data</code> maps for the plot <code>DF_HW</code> show seed prediction surfaces.</p></li>
<li><p>The <code>year effect groups</code> shows year effects for random groups in <code>treeData$province</code>.</p></li>
<li><p><code>partial ACF</code> shows partial autocorrelation by plot.</p></li>
</ul>
<p><br></p>
</div>
<div id="random-groups-and-individuals-with-multiple-species" class="section level2">
<h2><span style="color:teal">random groups and individuals with multiple species</span></h2>
<p>Most data sets have multiple seed types that complicate estimation of mast production by each species. This example considers <em>Pinus</em> spp, seeds of which cannot be confidently assigned to species. Here I load the data and generate a sample of maps from several years, including all species and seed types.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> &quot;https://github.com/jimclarkatduke/mast/blob/master/mast_pinu.Rdata?raw=True&quot;</span>
repmis::<span class="kw">source_data</span>(d)

mapList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">treeData =</span> treeData, <span class="dt">seedData =</span> seedData, 
                 <span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames, 
                 <span class="dt">xytree =</span> xytree, <span class="dt">xytrap =</span> xytrap)
<span class="kw">mastMap</span>(mapList, <span class="dt">mapPlot =</span> <span class="st">'DF_HW'</span>, <span class="dt">mapYears =</span> <span class="kw">c</span>(<span class="dv">2004</span>:<span class="dv">2007</span>), 
        <span class="dt">treeSymbol =</span> treeData$diam, <span class="dt">scaleTree =</span> .<span class="dv">5</span>, <span class="dt">scaleTrap=</span>.<span class="dv">5</span>,
        <span class="dt">scalePlot =</span> <span class="fl">1.2</span>, <span class="dt">LEGEND=</span>T)</code></pre></div>
<p>Note the tendency for high seed accumulation (large green squares) near dense, large trees (large brown circles).</p>
<p>Here is an AR(p) model by species with individual tree random effects.</p>
<p><br></p>
</div>
<div id="fitting-arp-and-random-effects-with-multiple-species" class="section level2">
<h2><span style="color:teal">fitting AR(p) and random effects with multiple species</span></h2>
<p>In this example, I again model seed production as a function of log diameter, <code>diam</code>, and tree growth rate, <code>canopy</code>, now for multiple species and seed types. This is an AR(p) model, because I include the number of lag terms <code>yearEffect$p = 5</code>,</p>
<p><span class="math display">\[\log \psi_{ij,t} \sim N \left( \mathbf{x}'_{ij,t} \mathbf{\beta}^x + \sum^p_{l=1} (\alpha_l + \alpha_{g[i],l}) \psi_{ij,t-l}, \sigma^2 \right)\]</span> Only years <span class="math inline">\(p &lt; t \le T_i\)</span> are used for fitting. Samples are drawn directly from the conditional posterior distribution.</p>
<p>In the table printed at the outset are trees by plot and year, i.e., the <code>specGroups</code> and <code>plotGroups</code> assigned in <code>inputs$yearEffect</code>. The zeros indicate either absence of trees or that no plots were sampled in those years. (These are not the same thing, <code>mastif</code> knows the difference).</p>
<p>In the code below I specify formulas, year and random effects, and some prior values. Due to the large number of trees, convergence is slow. Because I do not assume that trees of different species necessarily mast in the same years, I allow them to differ through random groups on years</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">formulaFec &lt;-<span class="st"> </span><span class="kw">as.formula</span>( ~<span class="st"> </span>canopy +<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) )   <span class="co"># fecundity model</span>
formulaRep &lt;-<span class="st"> </span><span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) )            <span class="co"># maturation model</span>

yearEffect   &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">specGroups =</span> <span class="st">'species'</span>, <span class="dt">plotGroups =</span> <span class="st">'region'</span>, <span class="dt">p =</span> <span class="dv">5</span>)   
randomEffect &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">randGroups =</span> <span class="st">'tree'</span>, 
                     <span class="dt">formulaRan =</span> <span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) ) )

seedMass &lt;-<span class="st"> </span><span class="kw">matrix</span>( <span class="kw">c</span>(<span class="fl">0.0170</span>,<span class="fl">0.0270</span>,<span class="fl">0.0167</span>,<span class="fl">0.0070</span>,<span class="fl">0.0080</span>), <span class="dt">ncol=</span><span class="dv">1</span>)
<span class="kw">rownames</span>(seedMass) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'pinuEchi'</span>,<span class="st">'pinuRigi'</span>,<span class="st">'pinuStro'</span>,<span class="st">'pinuTaed'</span>,<span class="st">'pinuVirg'</span>)
<span class="kw">colnames</span>(seedMass) &lt;-<span class="st"> 'gmPerSeed'</span>


inputs   &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames, 
                  <span class="dt">treeData =</span> treeData, <span class="dt">seedData =</span> seedData, 
                  <span class="dt">xytree =</span> xytree, <span class="dt">xytrap =</span> xytrap, <span class="dt">priorDist =</span> <span class="dv">20</span>,
                  <span class="dt">priorVDist =</span> <span class="dv">5</span>, <span class="dt">minDist =</span> <span class="dv">15</span>, <span class="dt">maxDist =</span> <span class="dv">30</span>, 
                  <span class="dt">minDiam =</span> <span class="dv">15</span>, <span class="dt">maxDiam =</span> <span class="dv">40</span>,
                  <span class="dt">maxF =</span> <span class="fl">1e+8</span>, <span class="dt">seedMass =</span> seedMass)
output &lt;-<span class="st"> </span><span class="kw">mastif</span>(formulaFec, formulaRep, <span class="dt">inputs =</span> inputs, <span class="dt">ng =</span> <span class="dv">2000</span>, 
               <span class="dt">burnin =</span> <span class="dv">500</span>, <span class="dt">yearEffect =</span> yearEffect, 
               <span class="dt">randomEffect =</span> randomEffect)</code></pre></div>
<p>Here is a restart:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> output &lt;-<span class="st"> </span><span class="kw">mastif</span>(<span class="dt">inputs =</span> output, <span class="dt">ng =</span> <span class="dv">2000</span>, 
               <span class="dt">burnin =</span> <span class="dv">1000</span>, <span class="dt">yearEffect =</span> yearEffect, 
               <span class="dt">randomEffect =</span> randomEffect)
plotPars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">MAPS =</span> F, <span class="dt">SPACETIME=</span>T, <span class="dt">SAVEPLOTS=</span>F)
<span class="kw">mastPlot</span>(output, <span class="dt">plotPars =</span> plotPars)</code></pre></div>
<p>Again, convergence will require more iterations. The AR(p) coefficients in the <code>lag effect group</code> panel shows the coefficients by random group. They are also shown in a separate panel, with each group plotted separately. In the <code>ACF eigenvalues</code> panel are shown the eigenvalues for AR lag coefficients on the real (horizontal) and imaginary (vertical) scales with the unit circle, within which oscillations are damped. The imaginary axis describes oscillations.</p>
<p>Here’s a restart with predictions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plots &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'DF_EW'</span>,<span class="st">'DF_BW'</span>,<span class="st">'DF_HW'</span>,<span class="st">'HF_ST'</span>)
years &lt;-<span class="st"> </span><span class="dv">1980</span>:<span class="dv">2025</span>
predList &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">mapMeters =</span> <span class="dv">8</span>, <span class="dt">plots =</span> plots, <span class="dt">years =</span> years ) 
output &lt;-<span class="st"> </span><span class="kw">mastif</span>(<span class="dt">inputs =</span> output, <span class="dt">predList =</span> predList, <span class="dt">yearEffect =</span> yearEffect, 
               <span class="dt">randomEffect =</span> randomEffect, <span class="dt">ng =</span> <span class="dv">2000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>)</code></pre></div>
<p>and updated plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mastPlot</span>( output, <span class="dt">plotPars =</span> <span class="kw">list</span>(<span class="dt">MAPS=</span>F) )</code></pre></div>
<p>Note that convergence requires additional iterations (larger <code>ng</code>). The predictions of seed production will progressively improve with convergence.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mastMap</span>(output, <span class="dt">mapPlot =</span> <span class="st">'DF_EW'</span>, <span class="dt">mapYears =</span> <span class="kw">c</span>(<span class="dv">2011</span>:<span class="dv">2012</span>), 
        <span class="dt">PREDICT=</span>T, <span class="dt">scaleTree =</span> <span class="dv">1</span>, <span class="dt">scaleTrap=</span>.<span class="dv">3</span>, <span class="dt">LEGEND=</span>T, <span class="dt">scaleValue=</span><span class="dv">50</span>,
        <span class="dt">scalePlot =</span> <span class="fl">1.5</span>, <span class="dt">COLORSCALE =</span> T, <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</code></pre></div>
<p>Or a larger view of a single map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mastMap</span>(output, <span class="dt">mapPlot =</span> <span class="st">'DF_EW'</span>, <span class="dt">mapYears =</span> <span class="dv">2014</span>, <span class="dt">PREDICT=</span>T, 
        <span class="dt">scaleTree =</span> <span class="dv">1</span>, <span class="dt">scaleTrap=</span>.<span class="dv">3</span>, <span class="dt">LEGEND=</span>T, <span class="dt">scalePlot =</span> <span class="dv">10</span>, 
        <span class="dt">SCALEBAR =</span> T, <span class="dt">COLORSCALE =</span> T)</code></pre></div>
<p>Here is a summary of parameter estimates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>( output )</code></pre></div>
<p>The names of species and seed types can be modified by <code>mast</code> to remove characters that can be confused or are reserved for specific purposes. <code>mast</code> also corrects for some inconsistencies, usually with a <code>warning</code>. For example, see the section on <strong>sample years</strong>.</p>
<p><br></p>
</div>
<div id="no-predictors" class="section level2">
<h2><span style="color:teal">no predictors</span></h2>
<p>In cases where there are no predictors that explain variation among individuals the <code>formula</code> can be limited to an intercept, using <code>~ 1</code>. In this case, it can be valuable to estimate fecundity even when there are no good predictors. For this intercept-only model, random effects and/or year effects can provide variation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> &quot;https://github.com/jimclarkatduke/mast/blob/master/mast_liri.Rdata?raw=True&quot;</span>
repmis::<span class="kw">source_data</span>(d)

formulaFec   &lt;-<span class="st"> </span><span class="kw">as.formula</span>(~<span class="st"> </span><span class="dv">1</span>)
formulaRep   &lt;-<span class="st"> </span><span class="kw">as.formula</span>( ~<span class="st"> </span><span class="kw">I</span>(<span class="kw">log</span>(diam)) ) 
yearEffect   &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">specGroups =</span> <span class="st">'species'</span>, <span class="dt">plotGroups =</span> <span class="st">'region'</span>)
randomEffect &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">randGroups =</span> <span class="st">'treeID'</span>, 
                     <span class="dt">formulaRan =</span> <span class="kw">as.formula</span>( ~<span class="st"> </span><span class="dv">1</span> ) )
inputs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">specNames =</span> specNames, <span class="dt">seedNames =</span> seedNames, 
               <span class="dt">treeData =</span> treeData, <span class="dt">seedData =</span> seedData, 
               <span class="dt">xytree =</span> xytree, <span class="dt">xytrap =</span> xytrap,
               <span class="dt">priorDist =</span> <span class="dv">10</span>, <span class="dt">priorVDist =</span> <span class="dv">5</span>, <span class="dt">maxDist =</span> <span class="dv">50</span>, <span class="dt">minDist =</span> <span class="dv">5</span>,
               <span class="dt">minDiam =</span> <span class="dv">25</span>, <span class="dt">maxF =</span> <span class="fl">1e+6</span>)
output &lt;-<span class="st"> </span><span class="kw">mastif</span>(inputs, formulaFec, formulaRep, <span class="dt">ng =</span> <span class="dv">2000</span>, <span class="dt">burnin =</span> <span class="dv">1000</span>,
               <span class="dt">randomEffect =</span> randomEffect, <span class="dt">yearEffect =</span> yearEffect )
<span class="kw">mastPlot</span>(output)</code></pre></div>
<p>Without predictors, the fitted variation is coming from random effects and year effects.</p>
<p><br></p>
</div>
</div>
<div id="when-trees-are-sampled-less-frequently-than-seeds" class="section level1">
<h1><span style="color:darkgreen">when trees are sampled less frequently than seeds</span></h1>
<p>Seed studies may include seed collections in years when trees are not censused. For example, tree data might be collected every 2 to 4. years, whereas, seeds are collected annually or subannually. In this case, there there are years in <code>treeData$year</code> that are missing from <code>seedData$year</code>. <code>mastif</code> needs a tree year for each seed year. If tree years are missing, <code>mastif</code> will try to construct them from the available data. If tree data are missing from some seed years, rather than rely on necessarily naive assumptions in <code>mastif</code>, it could be good to constuct a complete <code>treeData data.frame</code> that includes these missing years.</p>
<p><br></p>
</div>
<div id="convergence" class="section level1">
<h1><span style="color:darkgreen">convergence</span></h1>
<p>R code is highly vectorized. Unavoidable loops are written in C++ and exploit the C++ library <code>Armadillo</code>, available through <code>RcppArmadillo</code>. Alternating with Metropolis are Hamiltonian MC steps to encourage large movements.</p>
<p>Despite extensive vectorization and C++ for cases where loops are unavoidable, convergence can be slow. A collection of plots inventoried over dozens of years can generate in excess of <span class="math inline">\(10^6\)</span> tree-year observations and <span class="math inline">\(10^4\)</span> trap year observations. For reasons discussed in the appendix, there is no escaping the requirement of large numbers of indirectly sampled latent variables. If random effects are included, there are (obviously) as many random groups as there are trees. All tree fecundities must be imputed.</p>
<p><br></p>
</div>
<div id="appendix" class="section level1">
<h1><span style="color:darkgreen">appendix</span></h1>
<div id="model-overview" class="section level2">
<h2><span style="color:darkgreen">model overview</span></h2>
<p>Consider an inventory plot where trees produce seeds, depending on size, resource availability, competition, climate, and so on. The capacity to produce seed can increase with tree size. Individuals that have developed this capacity have reached <em>maturation</em>. The amount of seed produced in a year by a mature individual is termed <em>fecundity</em>. Seed traps accumulate seeds, depending on the combined fecundities of nearby trees, their dispersal capacities, and their distances from traps. Typically, data collection will involve multiple plots and multiple years. In order to estimate fecundity, I need to know the tree and seed trap locations, and I need to estimate dispersal together with seed production of each tree. For trees of unknown maturation status, that too must be estimated. Predictors that help to explain maturation and fecundity will improve estimates.</p>
</div>
<div id="observed-quantities" class="section level2">
<h2><span style="color:teal">observed quantities</span></h2>
<p>Let <span class="math inline">\(h = 1, \dots, H\)</span> designate species, and <span class="math inline">\(r = 1, \dots, R\)</span> designate the seed types that could have been produced by any of the <span class="math inline">\(H\)</span> species. Again, this distinction is needed, because not all seeds collected in traps can be identified to species. For example, if the plot includes trees of <em>Carya glabra</em> and <em>C. tomentosa</em>, then seed types might include <em>C. glabra</em>, <em>C. tomentosa</em>, and <em>Carya</em> spp, the latter including all seeds that could not be identified to species.</p>
<p>Here are the main elements of the model:</p>
<ul>
<li><p>An <em>observation</em> consists of covariates for trees and the seeds counted in seed traps. The components of an observation are <span class="math inline">\(\{ \mathbf{X}_{j,t}, \mathbf{V}_{j,t}, \mathbf{Y}_{j,t}, \mathbf{z}_{j,t} \}\)</span> for plot <span class="math inline">\(j, \dots, J\)</span> in years <span class="math inline">\(t, \dots, T_j\)</span>. There are <span class="math inline">\(i = 1, \dots, n_{j,t}\)</span> trees on plot <span class="math inline">\(j\)</span> in year <span class="math inline">\(t\)</span>. There are <span class="math inline">\(s = 1, \dots, S_{j,t}\)</span> seed traps in plot <span class="math inline">\(j\)</span> in year <span class="math inline">\(t\)</span>. The observation matrices are organized as tree-years or trap-years by variables, as follows:</p>
<ul>
<li><p><em>Predictors</em> that explain maturation occupy the <span class="math inline">\(n_{j,t} \times Q^m\)</span> matrix <span class="math inline">\(\mathbf{V}_{j,t}\)</span>. Predictors that explain fecundity occupy the <span class="math inline">\(n_{j,t} \times Q^f\)</span> matrix <span class="math inline">\(\mathbf{X}_{j,t}\)</span>. The different species <span class="math inline">\(h\)</span> are treated as factor levels in <span class="math inline">\(\mathbf{V}_{j,t}\)</span> and <span class="math inline">\(\mathbf{X}_{j,t}\)</span> having interactions with predictors. This design allows me to ignore a species label (it is absorbed into design matrices).</p></li>
<li><p>The <span class="math inline">\(S_{j,t} \times R\)</span> <em>response</em> matrix <span class="math inline">\(\mathbf{Y}_{j,t}\)</span> holds seed counts. It has one row for each seed-trap year and one column for each seed type <span class="math inline">\(r\)</span>.</p></li>
<li><p>The length-<span class="math inline">\(n_{j,t}\)</span> <em>maturation</em> vector <span class="math inline">\(\mathbf{z}_{j,t}\)</span> holds observed maturation states (often unknown).</p></li>
</ul></li>
<li><p>Elements of the <span class="math inline">\(S_{j,t} \times n_{j,t}\)</span> <em>redistribution kernel</em> matrix <span class="math inline">\(\mathbf{S}_{j,t}\)</span> depend on the distance from seed trap <span class="math inline">\((sj)\)</span> to tree <span class="math inline">\((ij)\)</span>. The <span class="math inline">\(t\)</span> subscript allows for ingrowth of new individuals and mortality loss and for the addition or loss of seed traps over time. <code>mastif</code> requires user input on tree and trap locations to set up matrix <span class="math inline">\(\mathbf{S}\)</span>.</p></li>
<li><p>The <em>detection error</em> is a length-<span class="math inline">\(R\)</span> composition vector <span class="math inline">\(\mathbf{r}_h\)</span> holding the fraction of seed produced by species <span class="math inline">\(h\)</span> that are identified to be seed type <span class="math inline">\(r\)</span>. The elements sum to 1. There are <span class="math inline">\(H\)</span> such vectors, one for each species.</p></li>
</ul>
</div>
<div id="dynamic-process" class="section level2">
<h2><span style="color:teal">dynamic process</span></h2>
<p>The process model is a state-space model for log fecundity and maturation, with joint distribution <span class="math inline">\([\psi_{ij,t}, \rho_{ij,t}]\)</span>. Log fecundity is continuous, <span class="math inline">\(\psi_{ij,t} \in (-\infty, \infty)\)</span>. True maturation status is the indicator <span class="math inline">\(\rho_{ij,t} \in \{0, 1\}\)</span>, subject to the constraint that maturation is a one-way process, <span class="math inline">\([\rho_{ij,t+1} = 1|\rho_{ij,t} = 1] = 1\)</span>, and <span class="math inline">\([\rho_{ij,t} = 1|\rho_{ij,t+1} = 0] = 0\)</span>. Fecundity is</p>
<p><span class="math display">\[f_{ij,t}  = \left \{
\begin{matrix}
\ \psi_{ij,t} &amp;  \rho_{ij,t} = 1\\
\ 0, &amp;  \rho_{ij,t} = 0
\end{matrix}
\right.\]</span> The latent states <span class="math inline">\(\psi\)</span> and <span class="math inline">\(\rho\)</span> are imputed and linked to observations with error.</p>
<p>There are predictors in <span class="math inline">\(\mathbf{v}_{ij,t}\)</span> that can account for maturation, including resource access and crowding. Predictors in <span class="math inline">\(\mathbf{x}_{ij,t}\)</span> explain diffences in seed production. Generatively, the model can start with a maturation status, modeled as a probit. Let <span class="math inline">\(\rho_{ij,t} = 1\)</span> be the event that individual <span class="math inline">\(ij\)</span> is mature at year <span class="math inline">\(t\)</span>, with probability,</p>
<p><span class="math display">\[[\rho_{ij,t} = 1] = \Phi \left( \mathbf{v}'_{ij,t} \mathbf{\beta}^v \right) \]</span> where <span class="math inline">\(\Phi()\)</span> is the standard normal distribution function. Mature individuals produce seeds at log fecundity</p>
<p><span class="math display">\[\log \psi_{ij,t} \sim N \left( \mathbf{x}'_{ij,t} \mathbf{\beta}^x, \sigma^2 \right)\]</span></p>
<p>The fecundity model is, in fact, flexible (Table 1).</p>
<p><strong>Table 1.</strong> Process models for log fecundity.</p>
<table>
<colgroup>
<col width="42%"></col>
<col width="57%"></col>
</colgroup>
<thead>
<tr class="header">
<th>terms</th>
<th>form</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fixed effects</td>
<td><span class="math inline">\(\mathbf{x}'_{ij,t} \mathbf{\beta}^x\)</span></td>
</tr>
<tr class="even">
<td>fixed year by random group</td>
<td><span class="math inline">\(\gamma_{t} + \gamma_{g,t}\)</span></td>
</tr>
<tr class="odd">
<td>AR(<span class="math inline">\(p\)</span>) fixed lag by random group</td>
<td><span class="math inline">\(\sum^p_{l=1} (\alpha_l + \alpha_{g,l}) \log \psi_{gij,t-l}\)</span></td>
</tr>
<tr class="even">
<td>random individual effect</td>
<td><span class="math inline">\(\mathbf{w}'_{ij,t} \mathbf{\beta}^w_{ij}\)</span></td>
</tr>
</tbody>
</table>
<p>The first line in Table 1 holds <em>fixed effects</em>, which apply to all models. At minimum, the fixed effect is an intercept, but there will typically be covariates and/or factors.</p>
<p><em>Year effects</em> <span class="math inline">\(\gamma_t\)</span> assign a coefficient to each year. Year effects are not recommended if there are year variables in the design matrix; year effects will compete with year variables in <span class="math inline">\(\mathbf{x}_{ij,t}\)</span>. When multiple random groups are specified, there is a random year effect, <span class="math inline">\(\gamma_{g,t}\)</span> for group <span class="math inline">\(g\)</span>.</p>
<p>AR(<span class="math inline">\(p\)</span>) is the <em>autoregressive model</em> with <span class="math inline">\(l = 1, \dots, p\)</span> lag terms, with coefficients <span class="math inline">\(\alpha_l\)</span>. If there are multiple groups, then these are random by group (subscript <span class="math inline">\(g\)</span>). Groups can be defined by plots within a region and/or species. Year effects cannot be used with AR effects.</p>
<p><em>Random individual</em> effects <span class="math inline">\(\beta_{ij}^w\)</span> can be used in combination with year effects or lag (AR) effects. Random individual require that individuals are observed repeatedly. They are a good idea when there are more than four years of data. They may not be a good idea if there are a number of individual variables in the design matrix (e.g., tree size, tree canopy area).</p>
<p>All models include <em>process error</em>, with variance <span class="math inline">\(\sigma^2\)</span>.</p>
</div>
<div id="observation-model" class="section level2">
<h2><span style="color:teal">observation model</span></h2>
<p>The observation model includes i) the <em>uncertain maturation</em> status of trees, ii) minimum and maximum visual seed counts, <em>fecundity estimates</em> on trees, iii) the <em>uncertain assignment</em> of seeds to species, and iv) <em>Poisson sampling</em> of seeds that have been redistributed to seed traps by dispersal.</p>
<div id="maturation-status-observations" class="section level3">
<h3><span style="color:brown">maturation status observations</span></h3>
<p>The maturation observation model recognizes uncertainty in the assignment of maturation (fruits are often unobservable in crowded canopies) and the fact that trees are not observed in many years. Let <span class="math inline">\(z_{ij,t}\)</span> be the observed status, which can be mature (fruits observed, <span class="math inline">\(z_{ij,t} = 1\)</span>), uncertain (fruits not observed, canopy obscure), and immature (<span class="math inline">\(z_{ij,t} = 0\)</span>). <span class="math inline">\(t_{ij,l}\)</span> is the last year in which individual <span class="math inline">\(ij\)</span> was observed to be immature. <span class="math inline">\(t_{ij,m}\)</span> is the first year <span class="math inline">\(ij\)</span> was observed in the mature state. Status is known to be mature any time after the tree is first observed to be mature and to be immature any time before the last time it is observed to have been immature. Between these times, the status is unknown and modeled with a probit:</p>
<p><span class="math display">\[ 
\begin{matrix}
\ z_{ij,t_m} = 0 \rightarrow  &amp; \rho_{ij,t} = 0, \forall t \leq t_m\\
\ z_{ij,t_l} = 1 \rightarrow  &amp; \rho_{ij,t} = 1, \forall t \geq t_l\\
\ t_l &lt; t &lt; t_m \rightarrow &amp; [\rho_{ij,t} = 1] =\Phi \left( \mathbf{v}'_{ijt} \mathbf{\beta}^v \right)
\end{matrix}
\]</span> where <span class="math inline">\(t_l\)</span> is an observation year earlier than <span class="math inline">\(t\)</span>, and <span class="math inline">\(t_m\)</span> is an observation year after year <span class="math inline">\(t\)</span></p>
</div>
<div id="fecundity-estimates" class="section level3">
<h3><span style="color:brown">fecundity estimates</span></h3>
<p>If there are visual estimates of seeds on a tree, these bound estimates of fecundity. For example, if cones are counted on trees, these counts can be multiplied by the expected range of seeds per cone to bound fecundity estimates.</p>
</div>
<div id="seed-counts-and-dispersal" class="section level3">
<h3><span style="color:brown">seed counts and dispersal</span></h3>
<p>Many of the seeds counted in traps could have been produced by more than one species. <em>Uncertainty in species assigment</em> for seeds must be estimated in the form of a length-<span class="math inline">\(R\)</span> composition vector <span class="math inline">\(\mathbf{r}_h\)</span>, where <span class="math inline">\(R\)</span> is the number of seed types to which species <span class="math inline">\(h\)</span> contributes seed. There is one vector for each species. Element <span class="math inline">\(r\)</span> is the fraction of seeds produced by trees of species <span class="math inline">\(h\)</span> that are expected as seed type <span class="math inline">\(r\)</span>. Elements of <span class="math inline">\(\mathbf{r}_h\)</span> sum to 1. The vector corresponding to individual <span class="math inline">\(i\)</span> is designated with the notation <span class="math inline">\(\mathbf{r}_{i[h]}\)</span>. The expected fecundity is</p>
<p><span class="math display">\[\mathbf{f}_{ij,t} = \mathbf{r}_{h[i]}\rho_{ij,t} \psi_{ij,t} \]</span> where <span class="math inline">\(\mathbf{f}_{ij,t}\)</span> is the length-<span class="math inline">\(R\)</span> vector of seed production for each seed type <span class="math inline">\(r\)</span>. Thus, the composition vector <span class="math inline">\(\mathbf{r}_{h[i]}\)</span> redistributes the seed produced by individual <span class="math inline">\(ij,t\)</span> among <span class="math inline">\(R\)</span> seed types.</p>
<p><em>Seed dispersal</em> induces dependence in seed trap counts by a <span class="math inline">\(S_{j,t} \times n_{j,t}\)</span> redistribution kernel <span class="math inline">\(\mathbf{S}_{s,t}\)</span>. Expected seeds per m<span class="math inline">\(^2\)</span> at seed traps <span class="math inline">\(s = 1, \dots, S_{j,t}\)</span> is</p>
<p><span class="math display">\[\mathbf{\Lambda}_{j,t} = \mathbf{S}_{j,t} \mathbf{F}_{j,t}\]</span> <span class="math inline">\(\mathbf{\Lambda}_{j,t}\)</span> is the <span class="math inline">\(S_{j,t} \times R\)</span> matrix of expected seed counts, and <span class="math inline">\(\mathbf{F}_{j,t}\)</span> is the <span class="math inline">\(n_{j,t} \times R\)</span> matrix of seed production from all trees on the plot.</p>
<p>The data model has likelihood</p>
<p><span class="math display">\[y_{rsj,t} \sim Poi(A_{sj,t} \lambda_{rsj,t})\]</span></p>
<p>where <span class="math inline">\(y_{rsj,t}\)</span> is the seed count for type <span class="math inline">\(r\)</span> in trap <span class="math inline">\(s\)</span> on plot <span class="math inline">\(j\)</span> in year <span class="math inline">\(t\)</span>, <span class="math inline">\(A_{sj,t}\)</span> is the area (e.g., meters) of the seed trap times the fraction of collecting time that trap <span class="math inline">\(sj,t\)</span> was active–seed traps are subject to damage.</p>
<p>The redistribution kernel <span class="math inline">\(\mathbf{S}_{j,t}\)</span> has elements</p>
<p><span class="math display">\[\mathbf{S}_{j,t[s,i]} =  \frac{u_{h[i]}}{\pi \left(u_{h[i]} + d^2_{s,i} \right)^2}\]</span> for distance <span class="math inline">\(d_{s,i}\)</span> and fitted dispersal parameter <span class="math inline">\(u_h\)</span> species (or random group) <span class="math inline">\(h\)</span> corresponding to tree <span class="math inline">\(i\)</span>. This is a two-dimensional Student’s <span class="math inline">\(t\)</span> distribution (Clark et al. 1999) and a special case of the Matern distribution, often used in spatial analysis models (e.g., Banerjee et al. CC). The mean dispersal distance is</p>
<p><span class="math display">\[\bar{d}_h = \frac{\pi \sqrt{u_h}}{2}\]</span> (Clark et al. 1999).</p>
</div>
</div>
<div id="why-is-fecundity-a-latent-variable" class="section level2">
<h2><span style="color:teal">why is fecundity a latent variable?</span></h2>
<p>A latent-variable treatment of fecundity is needed to allow for the way in which fecundity is related to seed counts, through a dispersal kernel. The expected seed intensity is the product of dispersal and fecundity,</p>
<p><span class="math display">\[\mathbf{\Lambda} = \mathbf{S} \mathbf{F}\]</span></p>
<p>Clearly, I can write out a solution for the <span class="math inline">\(n \times R\)</span> matrix <span class="math inline">\(\mathbf{F}\)</span>. However, there is a unique solution only if there are more seed traps in the <span class="math inline">\(S \times R\)</span> matrix <span class="math inline">\(\mathbf{\Lambda}\)</span> than there are sources in <span class="math inline">\(\mathbf{F}\)</span>, i.e., <span class="math inline">\(S &gt; n\)</span>. A bigger issue is the fact that this solution would undoubtedly include negative source values. Prior knowledge tells me that this is impossible. I thus require a model for <span class="math inline">\(\mathbf{F}\)</span>, which could be as simple as a prior distribution, which might impose nothing more than non-negative values. Or it can bring in predictors, in which case <span class="math inline">\(\mathbf{F}\)</span> could be replaced by a function of predictors. This is the approach taken by many seed-shadow models. Conditional fecundity <span class="math inline">\(\psi\)</span> and maturation status <span class="math inline">\(\rho\)</span> were introduced as latent variables hierarchically at least as early as Clark et al. (2004) to allow for knowledge of suitable range and maturation schedules and the large heterogeneity among trees. A hierarchical specification can be quite general, while still providing stability over suitable parameter ranges.</p>
</div>
<div id="where-is-the-information" class="section level2">
<h2><span style="color:teal">where is the information?</span></h2>
<p>Uncertainty in maturation and fecundity estimates depends on both the seed data (through the dispersal kernel) and the fecundity model. Trees that are distant from all seed traps are uninfluenced by seed data and derive all information from the maturation/fecundity model, relying on individual-scale covariates, such as tree diameter. Model fitting thus ultimately depends on the trees are are sufficiently close to affect seed counts. These are the trees that contribute to the coefficients in the process model, which, in turn, control fecundity estimates for distant trees. For this reason, uncertainty in maturation/fecundity estimates tends to be highest for trees having no nearby seed traps (Clark et al. 2004, 2010).</p>
</div>
</div>
<div id="algorithm-notes" class="section level1">
<h1><span style="color:darkgreen">algorithm notes</span></h1>
<div id="initialization" class="section level2">
<h2><span style="color:teal">initialization</span></h2>
<p>Model fitting begins with an Expectation-Maximumization (EM) step to initialize fecundities and the dispersal parameter <span class="math inline">\(u\)</span>, ignoring the fecundity model. The idea here is to find suitable initial states that predict the seed data, without regard to the regression model. This EM step focusses on trees that are close to seed traps, because these are the ones that contribute most to the data. Once this initialization of nearby trees is completed, remaining trees are initialized by predicting from the initial fecundity model fitted to these nearby trees.</p>
<p>From extensive simulation experiments it’s clear that convergence can occur from a range of initial states, but proper initialization accelerates it (Clark et al. 2004). Again, trees distant from seed traps are essentially ‘predicted’ from the fecundity model, rather than contributing much to the estimates themselves. The algorithm can be stabilized with prior distributions that bound fecundity and dispersal estimates to reasonable, albeit flexible, ranges (see below). The caveat here is that nothing useful will come from data sets where all plots are limited to few, distant trees. Conversely, crowded monocultures cannot inform about dispersal distance or individual fecundities. They can inform about averages.</p>
<p>In these notes I summarize algorithms used for posterior simulation and prediction.</p>
</div>
<div id="latent-states" class="section level2">
<h2><span style="color:teal">latent states</span></h2>
<p><code>mastif</code> is a state space model, with observed seeds <span class="math inline">\(y_{sj,t}\)</span> and maturation status <span class="math inline">\(z_{ij,t}\)</span>. Observed states are linked by data models to latent fecundity <span class="math inline">\(\psi_{ij,t}\)</span> and true maturation status <span class="math inline">\(\rho_{ij,t}\)</span>. To enhance mixing, the latent states are sampled with a combination of alternating methods. The first method samples maturation and fecundity jointly as a Metropolis random walk, with details depending on the process model. The second method conditions on maturation state and samples from the Hamiltonian.</p>
<div id="joint-fecundity-and-maturation-updates" class="section level3">
<h3><span style="color:brown">joint fecundity and maturation updates</span></h3>
<p>To impute states, fecundity and maturation status are proposed jointly as</p>
<p><span class="math display">\[[\psi^*_{ij,t}, \rho^*_{ij,t}] = [\psi^*_{ij,t} | \rho^*_{ij,t}][\rho^*_{ij,t}]\]</span> Maturation year is a random walk, centered on the currently imputed maturation year and subject to constraints imposed by observed or currently imputed states (mature individuals cannot become immature). Possible maturation years range from the last year in which an individual was observed in the immature state to the first year in which that individual was observed in the mature state. If there are no maturation observations, then all information on maturation status comes through the seed data. Maturation is proposed and accepted jointly with fecundity for all trees on a plot year. This blocking is necessitated by the fact that the likelihood for each trap-year conditionally depends on all tree-years for that plot (Clark et al. 2004).</p>
<p>Given proposed <span class="math inline">\(\rho^*_{ij,t}\)</span>, fecundity <span class="math inline">\(\psi^*_{ij,t}|\rho^*_{ij,t}\)</span> is proposed from a normal distribution, with censoring imposed by the proposed <span class="math inline">\(\rho^*_{ij,t}\)</span>,</p>
<p><span class="math display">\[\psi^*_{ij,t} | \rho^*_{ij,t} \sim N \left( \psi_{ij,t}, s_{ij,t} \right) I(r_1 &lt; \psi^*_{ij,t} \leq r_2)\]</span> where lower and upper bounds are <span class="math inline">\((r_1, r_2) = (0, \infty)\)</span> for <span class="math inline">\(\rho^*_{ijt} = 1\)</span> and <span class="math inline">\((-\infty, 0]\)</span> for <span class="math inline">\(\rho^*_{ijt} = 0\)</span>.</p>
<p>Again, proposal acceptance is done in a plot-year block, summarized this way:</p>
<p><span class="math display">\[[\boldsymbol{\psi}_{j,t}, \boldsymbol{\rho_{j,t}} | \mathbf{y}_{j,t}, \mathbf{z}_{j,t}] \propto P_1 \times P_2 \times P_3\]</span> where</p>
<p><span class="math display">\[\begin{align}
P_1 &amp;= \prod_{s=1}^{S_j} \prod_{r=1}^R Poi \left(y_{rkj,t} | A_{sj}  \lambda_{rsj,t}(\boldsymbol{\psi}_{j,t}, \boldsymbol{\rho}_{j,t}, \mathbf{r})\right) \\
P_2  &amp;= \prod_{i=1}^{n_i} [z_{ij,t} | \rho_{ij,t}] \\
P_3 &amp;=  \prod_{i=1}^{n_i} [\psi_{ij,t}| \rho_{ij,t}] 
\end{align}\]</span></p>
<p>(Conditioning on parameters is omitted to improve clarity.)</p>
<p>Sampling is done in either of two ways, depending on the process model, both beginning with proposed <span class="math inline">\(\{\rho^*_{ij,t} | \rho_{j,t-1}, \rho_{ij,t+1} \}_{i=1}^{n_j}\)</span> for all trees in plot-year <span class="math inline">\((j, t)\)</span> from a random walk. Then:</p>
<p>Method 1:</p>
<ol style="list-style-type: decimal">
<li>propose all <span class="math inline">\(\psi^*_{ij,t} | \rho^*_{ij,t}, \psi_{ij,t}\)</span> for the plot-year from a normal distribution centered on the currently imputed <span class="math inline">\(\psi_{ij,t}\)</span> with an adaptive variance parameter.</li>
<li>accept/reject <span class="math inline">\(\boldsymbol{\rho}^*_{j,t}, \boldsymbol{\psi}^*_{j,t}\)</span> as a block with probability <span class="math inline">\(P_1 P_2 P_3\)</span>.</li>
</ol>
<p>Method 2:</p>
<ol style="list-style-type: decimal">
<li>propose all <span class="math inline">\(\psi^*_{ij,t} | \rho^*_{ij,t}\)</span> for the plot-year from the conditional normal distribution obtained from <span class="math inline">\(P_3\)</span>. Details are limited to most complex case of the AR(p) model (see below).</li>
<li>accept/reject <span class="math inline">\(\boldsymbol{\rho}^*_{j,t}, \boldsymbol{\psi}^*_{j,t}\)</span> as a block with probability <span class="math inline">\(P_1 \times P_2\)</span>.</li>
</ol>
</div>
<div id="hamiltonian-updates" class="section level3">
<h3><span style="color:brown">Hamiltonian updates</span></h3>
<p>Hamiltonian updates cannot be used with discrete maturation status. However, by conditioning on maturation state, mixing of fecundity is accelerated with Hamiltonian updates for currently imputed mature individuals.</p>
<p>Each observation is a length-<span class="math inline">\(R\)</span> vector <span class="math inline">\(\mathbf{y}_{sj,t}\)</span> with Poisson intensity <span class="math inline">\(A_{sj} \lambda_{rsj,t} = A_{sj} \sum_{i=1}^{n_j,t} \mathbf{S}_{[sjt,i]} e^{\psi_{ij,t}} \mathbf{r}_{i[h],r}\)</span>, where <span class="math inline">\(\mathbf{r}_{i[h],r}\)</span> is the row vector <span class="math inline">\(\mathbf{r}\)</span> corresponding to the species of individual <span class="math inline">\(ij,t\)</span> and the column for seed type <span class="math inline">\(r\)</span>. The <span class="math inline">\(S_{j,t} \times n_{j,t}\)</span> kernel matrix <span class="math inline">\(\mathbf{S}_{j,t}\)</span> has elements <span class="math inline">\(\mathbf{S}_{[sjt,i]}\)</span> for row <span class="math inline">\(s\)</span> and column <span class="math inline">\(i\)</span>. The Hamiltonian can be written as</p>
<p><span class="math display">\[
H(\psi_{ij,t}, p) = B(\psi_{ij,t}) + C(p)
\]</span></p>
<p>where <span class="math inline">\(\psi_{ij,t} = \{\psi_{1,j,t}, \dots, \psi_{n_j,j,t} \}\)</span> is log fecundity for an individual on plot-year <span class="math inline">\((j,t)\)</span>, and <span class="math inline">\(C(p) = \sum_{i=1}^{n_j} \frac{p_i^2}{2m_i}\)</span> is the kinetic energy, taken as a quadratic function of momentum variables <span class="math inline">\(m_i\)</span>, which are tuned to optimize performance (Neal 2011). The first term incorporates the conditional distribution,</p>
<p><span class="math display">\[
\begin{align}
B(\psi_{ij,t}) &amp;= -\log \left(\pi(\psi_{ij,t} | \mathbf{y}_{j,t}, \mu_{ij,t},\sigma^2) \right) \\
 &amp; \propto \sum_{r,s} \left( - y_{rsj,t} \log \lambda_{rsj,t} + A_{sj} \lambda_{rsj,t} \right) + \frac{1}{2\sigma^2} (\psi_{ij,t} - \mu_{ij,t})^2 
\end{align}
\]</span> The gradient is used to direct proposals efficiently:</p>
<p><span class="math display">\[\frac{\partial B}{\partial \psi_{ij,t}} = 
e^{\psi_{ij,t}}\sum_{r} \mathbf{r}_{i[h],r}
\sum_s \mathbf{S}_{[sjt,i]} \left(- \frac{y_{rsj,t}}{\lambda_{rsj,t}} + A_{sj} \right) + \frac{1}{\sigma^2} \left( \psi_{ij,t} - \mu_{ij,t} \right)\]</span></p>
<p>Hamiltonian updates are individually slow, but affect larger steps then a Metrolis random walk, especially with large data sets. The two methods are mixed stochastically in the Gibbs sampler.</p>
</div>
</div>
<div id="coefficients" class="section level2">
<h2><span style="color:teal">coefficients</span></h2>
<p>Direct sampling of coefficients in <span class="math inline">\(\boldsymbol{\beta}^x\)</span> and <span class="math inline">\(\boldsymbol{\beta}^v\)</span> is available from Gaussian conditional posterior distributions. Gaussian prior distributions are non-informative. For <span class="math inline">\(\boldsymbol{\beta}^x\)</span> conditional distributions marginalize random effects (see below). The variance <span class="math inline">\(\sigma^2\)</span> has an inverse gamma prior – and is sampled directly from the conjugate inverse gamma posterior.</p>
</div>
<div id="random-individual-effects-1" class="section level2">
<h2><span style="color:teal">random individual effects</span></h2>
<p>A few notes here on the random effects algorithm. Let <span class="math inline">\(\mathbf{w}_{ij,t}\)</span> be a design vector holding all or some of the columns in <span class="math inline">\(\mathbf{x}_{ij,t}\)</span>. There is an individual-effects coefficient matrix <span class="math inline">\(\boldsymbol{\beta}^w_{ij}\)</span>,</p>
<p><span class="math display">\[\psi_{ij,t} \sim N \left( \mathbf{x}'_{ij,t} \boldsymbol{\beta}^x + \mathbf{w}'_{ij,t} \boldsymbol{\beta}^w_{ij}, \sigma^2 \right)\]</span> The prior distribution includes</p>
<p><span class="math display">\[
\begin{align}
\boldsymbol{\beta}^w_{ij}|\mathbf{B}_{w} &amp;\sim MVN(\mathbf{0},\mathbf{B}_{w}) \\
\mathbf{B}_{w} &amp;\sim IW \left( \tilde{\mathbf{B}}, df \right)
\end{align}
\]</span></p>
<p>where <span class="math inline">\(df = Q^w + 2\)</span>, <span class="math inline">\(Q^w\)</span> is the number of columns in <span class="math inline">\(\mathbf{w}_{ij,t}\)</span>, and <span class="math inline">\(\tilde{\mathbf{A}} = \mathbf{I}_r\)</span> is a prior diagonal matrix. The conditional posterior matrix is</p>
<p><span class="math display">\[\boldsymbol{\beta}^w_{ij}|\boldsymbol{\beta}^x, \mathbf{B}_w \sim MVN(\mathbf{V}_{ij}\mathbf{v}_{ij},\mathbf{V}_{ij})\]</span> where</p>
<p><span class="math display">\[\begin{align}
\mathbf{v}_{ij} &amp;= \frac{1}{\sigma^2} \sum_{t \in \{t_i\}} 
\mathbf{w}_{ijt} (\psi_{ijt} -  \mathbf{x}'_{ijt} \boldsymbol{\beta}^x ) \\
\mathbf{V}_{ij} &amp;= \frac{1}{\sigma^2} \sum_{t \in \{t_i\}} 
\mathbf{w}_{ijt} \mathbf{w}'_{ijt} + \mathbf{B}_w^{-1}
\end{align}\]</span></p>
<p>The summations are taken over all observation years for an individual <span class="math inline">\(i\)</span>, the set <span class="math inline">\(\{ t_i \}\)</span> for which the individual is mature. Here is the conditional for the covariance,</p>
<p><span class="math display">\[\mathbf{B}_w|\{ \boldsymbol{\beta}^w_{ij}\}  \sim IW \left( 
\sum \boldsymbol{\beta}^w_{ij} \boldsymbol{\beta}^{w'}_{ij} + df \times \tilde{\mathbf{B}}, \sum_j n_j + df 
\right)\]</span></p>
</div>
<div id="random-groups-in-the-year-and-arp-models" class="section level2">
<h2><span style="color:teal">random groups in the year and AR(<span class="math inline">\(p\)</span>) models</span></h2>
<p>The year and AR(<span class="math inline">\(p\)</span>) models allow for group random effects on year and lag coefficients, respectively–if groups are defined by the user, they will be treated as random. This is done, because year and lag terms across groups are highly unbalanced. Plot-species groups can hold different numbers of plots and trees in different years. Plots can be established at different times, have different plot areas, and support very different communities of species. For a given species, abundance across plots may range from zero to high. Within plots, numbers of mature individuals vary across years with recruitment, maturation, and death. Within posterior simulation, their imputed maturation statuses change by tree and year. The sizes of design matrices are thus dynamic.</p>
<p>Given this imbalance, treating groups as random provides the advantage that no arbitrary rules are needed to catch computation errors that would result from plot-years that are at some iterations imputed to have mature trees and other iterations not.</p>
</div>
<div id="arp-model" class="section level2">
<h2><span style="color:teal">AR(<span class="math inline">\(p\)</span>) model</span></h2>
<p>The AR(<span class="math inline">\(p\)</span>) model allows for the dependence of the current states of <span class="math inline">\(\psi_t\)</span> on <span class="math inline">\(p\)</span> previous states. The process is homogeneous in time, because the lag coefficients <span class="math inline">\(\alpha_p\)</span> are constant. I start with a few words on structure.</p>
<div id="imputed-past-predicted-future" class="section level3">
<h3><span style="color:brown">imputed past, predicted future</span></h3>
<p>AR models handle the early years in different ways. There is no AR(<span class="math inline">\(p\)</span>) estimate for years <span class="math inline">\(t \in \{1, \dots, p \}\)</span>. One of the more common ways to deal with these years is to simply condition on them. This seems like a big price to pay. Because <code>mastif</code> is a state-space model, and I am imputing fecundity and maturation anyway, it makes sense to imput fecundity/maturation for years <span class="math inline">\(t-p, \dots, t-1\)</span>.</p>
<p>So while I am imputing the past, it makes sense to predict the future. Conditionally, fecundity in the final year <span class="math inline">\(T_i\)</span> depends on the future, up to year <span class="math inline">\(T_i + p\)</span>. To accommodate past and future, <code>mastif</code> imputes backward <span class="math inline">\(p\)</span> years from the first observation and predicts forward <span class="math inline">\(p\)</span> years beyond the last observed year.</p>
<p>A consistent treatment would appear to demand that AR effects be restricted to individuals that have been mature for the past <span class="math inline">\(t - p\)</span> years. Note that this would not be a concern if maturation state was known. I adopt this rule, so lag effect estimates are not biased downward by the inclusion of trees that might have been immature and, thus, having no effect.</p>
<p>Although fecundity is imputed for all years, including before observations began, sampling of coefficients for fixed effects and lag effects is restricted to years in which trees were observed and mature.</p>
</div>
<div id="arp-model-structure" class="section level3">
<h3><span style="color:brown">AR(p) model structure</span></h3>
<p>To avoid further notation, the description that follows should be understood to apply only to tree-years for which the mature state extends back to <span class="math inline">\(t - p\)</span> years. Also to simplify notation I initially omit the subscript <span class="math inline">\(j\)</span>. Note that multiple plots <span class="math inline">\(j\)</span> might fall within a group <span class="math inline">\(g\)</span>.</p>
<p>Conditionally, the model for an individual <span class="math inline">\(i\)</span> in group <span class="math inline">\(g \in \{1, \dots, G \}\)</span> could be written as</p>
<p><span class="math display">\[\psi_{ig,t} | \mu_{ig,t}, \boldsymbol{\alpha}, \boldsymbol{\alpha}_g, \boldsymbol{\tilde{\psi}}_{ig,t}
\sim N \left(  m_{ig,t}, \sigma^2 \right)\]</span></p>
<p>where</p>
<p><span class="math display">\[
\begin{align}
m_{ig,t} &amp;= \mu_{ig,t} +  \sum^p_{l=1} (\alpha_l + \alpha_{gl}) \psi_{ig,t-l} \\
  &amp;= \mu_{ig,t} + (\boldsymbol{\alpha} + \boldsymbol{\alpha}_{g})' \boldsymbol{\tilde{\psi}}_{ig,t}
\end{align}
\]</span></p>
<p><span class="math inline">\(\mu_{ig,t} = \mathbf{x}'_{ig,t} \boldsymbol{\beta}^x\)</span> is the fixed effect, <span class="math inline">\(\boldsymbol{\tilde{\psi}}_{ig,t} = (\psi_{ig,t-1}, \dots, \psi_{ig,t-p})'\)</span> is the vector of lagged fecundities for <span class="math inline">\((ig,t)\)</span>, <span class="math inline">\(\boldsymbol{\alpha} = (\alpha_1, \dots, \alpha_p)'\)</span> is the vector of fixed effects for lag <span class="math inline">\(l = 1, \dots, p\)</span>, and <span class="math inline">\(\boldsymbol{\alpha}_g = (\alpha_{g1}, \dots, \alpha_{gp})\)</span> is the random effect for group <span class="math inline">\(g\)</span> with prior distribution</p>
<p><span class="math display">\[\begin{align}
\boldsymbol{\alpha}_{g} &amp;\sim MVN(\mathbf{0}, \mathbf{A}_{(l)}) \\
\mathbf{A}_{(l)} &amp;\sim IW \left( \tilde{\mathbf{A}}_{(l)}, df \right)
\end{align}\]</span></p>
<p>To facilitate sampling, the fecundity values are organized into a vector <span class="math inline">\(\boldsymbol{\psi} = \{\psi_{ig,t} | i = 1, \dots, n, g = 1, \dots, G, t = 1, \dots, T_i \}\)</span> and a corresponding matrix of <span class="math inline">\(p\)</span> lag terms. For example, a vector with these subscripts</p>
<p><span class="math display">\[\boldsymbol{\psi} = \left( \psi_{i,g,t}, \psi_{i,g,t+1}, \dots, \psi_{i,g,T_i}, \psi_{i+1,g,t}, \dots, \right)\]</span> has the lag matrix with matching rows and <span class="math inline">\(p\)</span> columns,</p>
<p><span class="math display">\[ \boldsymbol{\tilde{\Psi}} = 
\pmatrix{
\psi_{i,g,t-1} &amp; \dots &amp; \psi_{i,g,t-p} \\
\psi_{i,g,t} &amp; \dots &amp; \psi_{i,g,t+1-p} \\
\vdots &amp; \vdots &amp; \vdots \\
\psi_{i,g,T_i-1} &amp; \dots &amp; \psi_{i,g,T_i-p} \\
\psi_{i+1,g,t} &amp; \dots &amp; \psi_{i+1,g,t+1-p} \\
\vdots &amp; \vdots &amp; \vdots
}.
\]</span></p>
<p>Construct the matrix:</p>
<p><span class="math display">\[ \mathbf{G} = 
\pmatrix{
\psi_1 &amp; \psi_2 &amp; \dots &amp; \psi_{p-1} &amp; \psi_p \\
1 &amp; 0 &amp;\dots &amp; 0 &amp; 0 \\
0 &amp; 1 &amp;\dots &amp; 0 &amp; 0 \\
\vdots &amp; \ddots &amp; \ddots &amp; \ddots &amp; \vdots \\
0 &amp; 0 &amp; \dots &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \dots &amp; 1 &amp; 0
}.
\]</span> (West and Harrison 1994). A stationary AR(<span class="math inline">\(p\)</span>) process has all eigenvalues of less than unit modulus (whether real or complex). A quasi-periodic process has complex eigenvalues.</p>
</div>
<div id="sample-fixed-effects" class="section level3">
<h3><span style="color:brown">sample fixed effects</span></h3>
<p>To sample fixed effects, I move a few terms to the left,</p>
<p><span class="math display">\[\mathbf{m} = \boldsymbol{\tilde{\Psi}} \boldsymbol{\alpha}\]</span> where <span class="math inline">\(\mathbf{m}\)</span> has elements <span class="math inline">\(\psi_{ig,t} - \mu_{ig,t} - \boldsymbol{\alpha}_{g[i]}' \boldsymbol{\tilde{\psi}}_{ig,t}\)</span>, and <span class="math inline">\(\boldsymbol{\alpha}_{g[i]}\)</span> indicates the vector of lags for the group to which individual <span class="math inline">\(i\)</span> belongs. The conditional posterior matrix for fixed effects is</p>
<p><span class="math display">\[\begin{align}
\boldsymbol{\alpha}|\{\boldsymbol{\alpha}_g \} &amp;\sim MVN(\mathbf{V}\mathbf{v},\mathbf{V}) \\
\mathbf{v} &amp;= \sigma^{-2}\boldsymbol{\tilde{\Psi}}'\mathbf{m} \\
\mathbf{V}^{-1} &amp;=\sigma^{-2}\boldsymbol{\tilde{\Psi}}'\boldsymbol{\tilde{\Psi}} + \mathbf{A}^{-1}
\end{align}\]</span></p>
</div>
<div id="random-group-effects" class="section level3">
<h3><span style="color:brown">random group effects</span></h3>
<p>For random effects, make a slight change in <span class="math inline">\(\mathbf{m}\)</span>,</p>
<p><span class="math display">\[\begin{align}
\boldsymbol{\alpha}_g &amp;\sim MVN(\mathbf{V}_g\mathbf{v}_g,\mathbf{V}_g) \\
\mathbf{v}_g &amp;= \frac{1}{\sigma^2} \sum_{i,t} 
\boldsymbol{\tilde{\psi}}'_{ig,t} m_{ig,t} \\
\mathbf{V}_g &amp;= \frac{1}{\sigma^2} \sum_{i,t} 
\boldsymbol{\tilde{\psi}}_{ig,t} \boldsymbol{\tilde{\psi}}'_{ig,t} + \mathbf{A}_{(l)}^{-1}
\end{align}
\]</span></p>
<p>where <span class="math inline">\(m_{ig,t} = \psi_{ig,t} - \mu_{ig,t} - \boldsymbol{\alpha}' \boldsymbol{\tilde{\psi}}_{ig,t}\)</span>. The summations are taken over all observation years in which individual <span class="math inline">\(i\)</span> has been in the mature state for the previous <span class="math inline">\(p\)</span> years, for all individuals in group <span class="math inline">\(g\)</span>. Here is the conditional for the covariance,</p>
<p><span class="math display">\[\mathbf{A}_{(l)}|\{ \boldsymbol{\alpha}_g \}  \sim IW \left( \sum_{g=1}^G
\boldsymbol{\alpha}_g \boldsymbol{\alpha}'_g + df \times \tilde{\mathbf{A}}_{(l)}, G + df 
\right)\]</span></p>
</div>
<div id="latent-states-1" class="section level3">
<h3><span style="color:brown">latent states</span></h3>
<p>Latent states in the AR(p) model are sampled by proposing from the conditional posterior for the fecundity/maturation submodel <span class="math inline">\(\psi_t, z_t | \psi_{\{-t\}}, z_{t-1},z_{t+1}\)</span> and accepting from the likelihood for seed data (Method 2). To reduce clutter, I now omit subscripts <span class="math inline">\(ijg\)</span>. If there are random groups in the model, then everything I say below is handled at the group level, with lag coefficient <span class="math inline">\(\alpha_l\)</span> being replaced with <span class="math inline">\(\alpha_l + \alpha_{gl}\)</span> for group <span class="math inline">\(g\)</span>.</p>
<p>The AR(p) model can be written as</p>
<p><span class="math display">\[\psi_t \sim N \left(  m_t, \sigma^2 \right)\]</span></p>
<p>where</p>
<p><span class="math display">\[m_t = \mu_t +  \sum^p_{l=1} \alpha_l \psi_{t-l}\]</span></p>
<p>The exponent of the conditional distribution <span class="math inline">\(\psi_t | \psi_{\{-t\}}\)</span> can be factored this way:</p>
<p><span class="math display">\[\frac{1}{\sigma^2} \left[ \left( \psi_t - m_t \right)^2 + \sum_{k=1}^p \left( n_{t,k} - \alpha_k \psi_t  \right)^2 \right]\]</span></p>
<p>where</p>
<p><span class="math display">\[n_{t,k} = \psi_{t+k} - \mu_{t+k} - \sum_{l=1}^p \alpha_l \psi_{t+k-l}I(l\neq k)\]</span> All of this goo just isolates the terms in <span class="math inline">\(\psi_t\)</span>.</p>
<p>To sample latent states, I propose from</p>
<p><span class="math display">\[\psi_t \sim N \left( V v_t, V \right)\]</span></p>
<p>where</p>
<p><span class="math display">\[\begin{align}
v_t &amp;= \frac{1}{\sigma^2} \left( m_t + \sum_{k=1}^p n_{t,k} \alpha_k \right) \\
V^{-1} &amp;= \frac{1}{\sigma^2} \left( 1 + \sum_{k=1}^p \alpha_k^2 \right)
\end{align}
\]</span></p>
<p>Proposals are accepted as a block for each plot-year in the data set, based on the likelihood for seed data (see Method 2).</p>
</div>
<div id="year-effects" class="section level3">
<h3><span style="color:brown">year effects</span></h3>
<p>For a single group, years effects are fixed, drawn from the conditional</p>
<p><span class="math display">\[
\begin{align}
\gamma_t &amp;\sim N(V_t v_t, V_t) \\
V_{t}^{-1} &amp;= \frac{n_t}{\sigma^2} + 1/\tau^2 \\
v_{t} &amp;= \frac{1}{\sigma^2} \sum_{i}(\psi_{i,t} - \mu_{i,t})
\end{align}
\]</span></p>
<p>With multiple groups, there are random year effects across groups:</p>
<p><span class="math display">\[\begin{align}
\gamma_{g,t} &amp;\sim N(V_t v_t, V_t) \\
V_{g,t}^{-1} &amp;= \frac{n_{g,t}}{\sigma^2} + 1/\tau^2_t \\
v_{g,t} &amp;= \frac{1}{\sigma^2} \sum_{i \in g}(\psi_{i,t} - \mu_{i,t} - \gamma_t)
\end{align}
\]</span></p>
<p>Years have a sum-to-zero constraint imposed in Gibbs sampling. The intercept for a given year is the overall intercept plus the year effect for that year.</p>
<p>The variance for random effects:</p>
<p><span class="math display">\[
\tau^2_t \sim IG \left( 2 + \frac{n_t}{2}, 1 + \frac{1}{2} \sum\gamma_{g,t}^2 \right)
\]</span> where <span class="math inline">\(n_t\)</span> is the number of groups available in year <span class="math inline">\(t\)</span>, i.e., those having mature individuals in that year.</p>
</div>
<div id="other-parameters" class="section level3">
<h3><span style="color:brown">other parameters</span></h3>
<p>The error variance <span class="math inline">\(\sigma^2\)</span> is sampled from the conditional inverse gamma posterior distribution.</p>
<p>If there are no random groups, the dispersal parameter <span class="math inline">\(u\)</span> is sampled with Metropolis, with an adaptive proposal variance and truncated normal prior distribution,</p>
<p><span class="math display">\[
[u] \propto  L \times N(u | u_0, U_0) I(u &gt; 0)
\]</span> where the likelihood <span class="math inline">\(L\)</span> is <span class="math inline">\(\prod_{r,s,j,t} Poi \left(y_{rsj,t} | A_{sj} \lambda_{rsj,t}(u,\boldsymbol{\psi}_{j,t}, \boldsymbol{\rho}_{j,t}, \mathbf{r})\right)\)</span>, <span class="math inline">\(u_0\)</span> and <span class="math inline">\(U_0\)</span> are the prior mean and variance dispersal parameters.</p>
<p>If there are random groups, then an additional stage for the global mean. The previous distribution applies to <span class="math inline">\(u_g\)</span> for group <span class="math inline">\(g\)</span>,</p>
<p><span class="math display">\[
[u_g] \propto  L \times N(u_g | u, U)
\]</span> The <span class="math inline">\(u_g\)</span> are proposed and accepted as a block.</p>
<p>The global mean and variance have conditional distributions:</p>
<p><span class="math display">\[
\begin{align}
u | u_1, \dots, u_G, u_0, U,U_0 &amp;\sim N \left(Vv,V \right) \\
V^{-1} &amp;= \frac{G}{U} + \frac{1}{U_0} \\
v  &amp;= \frac{1}{U} \sum_g  u_g  + \frac{ u_0 }{U_0} \\
U |u_1, \dots, u_G, u  &amp;\sim IG \left(2 + \frac{G}{2}, 1 + \frac{1}{2} \sum_g ( u_g  -  u )^2 \right)
\end{align}
\]</span></p>
</div>
</div>
</div>
<div id="references" class="section level1">
<h1><span style="color:darkgreen">references</span></h1>
<p>Clark, JS, DM Bell, M Kwit, A Powell, and K Zhu. 2013. Dynamic inverse prediction and sensitivity analysis with high-dimensional responses: application to climate-change vulnerability of biodiversity. <em>Journal of Biological, Environmental, and Agricultural Statistics</em> 18, 376-404.</p>
<p>Clark, JS, C Nunes, and B Tomasek. 2018. Pulsed-resource mast systems and the movement, demographic storage and diet breadth of consumers, in review.</p>
<p>Clark, JS, S LaDeau, and I Ibanez. 2004. Fecundity of trees and the colonization-competition hypothesis, <em>Ecological Monographs</em>, 74, 415-442.</p>
<p>Clark, JS, M Silman, R Kern, E Macklin, and J Hille Ris Lambers. 1999. Seed dispersal near and far: generalized patterns across temperate and tropical forests. <em>Ecology</em> 80, 1475-1494.</p>
<p>Neal, R.M. 2011. MCMC using Hamiltonian dynamics. In: <em>Handbook of Markov Chain Monte Carlo</em>, edited by S. Brooks, A. Gelman, G. Jones, and X.-L. Meng. Chapman &amp; Hall / CRC Press.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
